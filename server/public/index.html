<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ResearchNet-X | Research Database Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Add this line after your existing FontAwesome link -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>

        /* Custom Cursor */
.cursor {
    position: fixed;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    pointer-events: none;
    z-index: 9999;
    mix-blend-mode: difference;
    transition: transform 0.2s;
}

.cursor-follower {
    position: fixed;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid rgba(102, 126, 234, 0.3);
    pointer-events: none;
    z-index: 9998;
    transition: all 0.4s;
}

/* Particle Burst Effect */
.particle-burst {
    position: absolute;
    width: 4px;
    height: 4px;
    background: linear-gradient(45deg, #667eea, #f093fb);
    border-radius: 50%;
    pointer-events: none;
    opacity: 0;
}

/* Add to body */
body {
    cursor: none;
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--dark-bg);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
}

/* Hide cursor on mobile */
@media (max-width: 768px) {
    body {
        cursor: default;
    }
    .cursor, .cursor-follower {
        display: none;
    }
}
        /* Smooth scrolling for the entire page */
html {
    scroll-behavior: smooth;
}

/* Ensure sections have proper spacing for scrolling */
.section {
    min-height: calc(100vh - 200px); /* Adjust based on your header/nav height */
    padding-top: 20px; /* Add some top padding for better scrolling position */
}

/* Container for sections */
.container {
    scroll-margin-top: 120px; /* Adjust based on your header height */
}
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Dark Theme Variables (Default) */
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --warning-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --info-gradient: linear-gradient(135deg, #a3bded 0%, #6991c7 100%);
            
            --dark-bg: #0f172a;
            --card-bg: rgba(255, 255, 255, 0.05);
            --text-primary: #ffffff;
            --text-secondary: #cbd5e1;
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.12);
            
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 20px rgba(0, 0, 0, 0.2);
            --shadow-sm: 0 5px 15px rgba(0, 0, 0, 0.1);
            
            --transition-fast: 0.2s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
            
            --border-radius: 15px;
        }

        [data-theme="light"] {
            --dark-bg: #f8fafc;
            --card-bg: rgba(255, 255, 255, 0.9);
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--dark-bg);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .animated-gradient-bg {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            opacity: 0.03;
            z-index: -2;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Glassmorphism Effect */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        /* Header */
        header {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.9), rgba(118, 75, 162, 0.9));
            padding: 1rem 0;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1.5rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Theme Toggle */
        .theme-toggle {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-normal);
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .theme-toggle:hover {
            background: var(--primary-gradient);
            transform: rotate(30deg) scale(1.1);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }

        /* Search Bar */
        .search-container {
            position: relative;
            flex: 1;
            max-width: 500px;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 30px;
            color: var(--text-primary);
            font-size: 14px;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-sm);
        }

        .search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3), var(--shadow-md);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        /* Navigation */
        nav {
            max-width: 1400px;
            margin: 1.5rem auto;
            padding: 0 2rem;
        }
        /* Add this to reduce space between nav and content */
nav {
    margin-top: 0.5rem !important;
    margin-bottom: 0.5rem !important;
}

.section.active {
    margin-top: -2.5rem; /* Pull content up slightly */
}
        /* Hover Card Styles */
.hover-card {
    position: fixed;
    background: var(--card-bg);
    border: 1px solid var(--glass-border);
    border-radius: var(--border-radius);
    padding: 1.5rem;
    width: 350px;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    display: none;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.3s ease, transform 0.3s ease;
    backdrop-filter: blur(20px) saturate(180%);
}

.hover-card.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

.hover-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.hover-card-title {
    font-size: 1.3rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    flex: 1;
}

.hover-card-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    font-size: 1.2rem;
    cursor: pointer;
    padding: 5px;
    transition: color 0.2s ease;
}
/* Section Transitions */
.section {
    display: none;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
}

.section.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

/* Smooth tab switching */
.nav-tab {
    position: relative;
    overflow: hidden;
}

.nav-tab::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.7s;
}

.nav-tab:hover::before {
    left: 100%;
}
/* Form Styles */
.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
    font-weight: 600;
    font-size: 0.9rem;
}

.form-input {
    width: 100%;
    padding: 12px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    transition: all var(--transition-normal);
}

.form-input:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
}
/* Form Controls - Custom Dropdown Styling */
.form-select {
    width: 100%;
    padding: 12px;
    background: var(--glass-bg) !important;
    border: 1px solid var(--glass-border) !important;
    border-radius: 8px;
    color: var(--text-primary) !important;
    font-size: 14px;
    cursor: pointer;
    appearance: none; /* Remove default arrow */
    -webkit-appearance: none; /* Remove default arrow for Safari */
    -moz-appearance: none; /* Remove default arrow for Firefox */
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 12px center !important;
    background-size: 16px !important;
    padding-right: 40px !important;
}

.form-select:focus {
    outline: none;
    border-color: #667eea !important;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2) !important;
}

.form-select option {
    background: var(--card-bg) !important;
    color: var(--text-primary) !important;
    padding: 12px;
}

/* Fix for Firefox dropdown options */
.form-select:-moz-focusring {
    color: transparent;
    text-shadow: 0 0 0 var(--text-primary);
}

/* Custom styling for dropdown options */
.form-select option:checked {
    background: linear-gradient(135deg, #667eea, #764ba2) !important;
    color: white !important;
}

.form-select option:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important;
}

/* Fix for multiple select */
.form-select[multiple] {
    background-image: none !important;
    padding-right: 12px !important;
    min-height: 150px;
}

.form-select[multiple] option {
    padding: 8px 12px;
    margin: 2px 0;
    border-radius: 4px;
}

/* Specific styling for the dropdown in dark theme */
[data-theme="dark"] .form-select {
    background-color: var(--card-bg) !important;
    border-color: var(--glass-border) !important;
    color: var(--text-primary) !important;
}

[data-theme="dark"] .form-select option {
    background-color: var(--card-bg) !important;
    color: var(--text-primary) !important;
}

[data-theme="dark"] .form-select:focus {
    background-color: rgba(255, 255, 255, 0.1) !important;
}

/* Ensure dropdowns in modals are also styled */
.modal-content .form-select {
    background: rgba(30, 41, 59, 0.9) !important;
    border-color: rgba(255, 255, 255, 0.15) !important;
}

[data-theme="dark"] .modal-content .form-select option {
    background: rgba(30, 41, 59, 0.95) !important;
}

/* Filter controls dropdowns */
.filter-select {
    padding: 10px 15px;
    background: var(--glass-bg) !important;
    border: 1px solid var(--glass-border) !important;
    border-radius: 8px;
    color: var(--text-primary) !important;
    min-width: 180px;
    font-size: 14px;
    appearance: none !important;
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e") !important;
    background-repeat: no-repeat !important;
    background-position: right 12px center !important;
    background-size: 16px !important;
    padding-right: 40px !important;
}

/* Fix for Safari */
@media not all and (min-resolution:.001dpcm) {
    @supports (-webkit-appearance:none) {
        .form-select,
        .filter-select {
            background-color: var(--glass-bg) !important;
        }
    }
}

.form-textarea {
    width: 100%;
    padding: 12px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    color: var(--text-primary);
    font-size: 14px;
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    margin-top: 2rem;
    padding-top: 1rem;
    border-top: 1px solid var(--glass-border);
}

.form-error {
    color: #f5576c;
    font-size: 0.85rem;
    margin-top: 0.25rem;
    display: none;
}
/* Style for Advanced Search button */
.btn-advanced-search {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    color: var(--text-primary);
    border: 1px solid var(--glass-border);
    padding: 12px 20px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all var(--transition-normal);
    display: flex;
    align-items: center;
    gap: 8px;
    white-space: nowrap;
}

.btn-advanced-search:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
}
/* Badge colors for buttons */
.btn-success {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    color: white;
    border: none;
}

.btn-warning {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    color: white;
    border: none;
}

.btn-danger {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
    color: white;
    border: none;
}

.btn-success:hover, .btn-warning:hover, .btn-danger:hover {
    transform: translateY(-2px);
    opacity: 0.9;
}

/* File upload */
.file-upload {
    border: 2px dashed var(--glass-border);
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-normal);
}

.file-upload:hover {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.05);
}

.file-upload input {
    display: none;
}

/* Tags input */
.tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    padding: 10px;
    background: var(--glass-bg);
    border: 1px solid var(--glass-border);
    border-radius: 8px;
    min-height: 45px;
}

.tag {
    background: linear-gradient(135deg, #667eea, #764ba2);
    color: white;
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 0.8rem;
    display: flex;
    align-items: center;
    gap: 5px;
}

.tag-remove {
    cursor: pointer;
    font-size: 0.7rem;
    opacity: 0.8;
}

.tag-remove:hover {
    opacity: 1;
}

.tag-input {
    border: none;
    background: transparent;
    color: var(--text-primary);
    flex: 1;
    min-width: 100px;
    padding: 5px;
}

.tag-input:focus {
    outline: none;
}
.hover-card-close:hover {
    color: var(--text-primary);
}

.hover-card-body {
    color: var(--text-secondary);
}

.hover-card-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.8rem;
    margin: 1.2rem 0;
}

.hover-card-stat {
    text-align: center;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

.hover-card-stat-number {
    font-size: 1.5rem;
    font-weight: 800;
    color: #667eea;
    margin-bottom: 0.3rem;
}

.hover-card-stat-label {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    opacity: 0.8;
}

.hover-card-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0;
}

.hover-card-list li {
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    display: flex;
    align-items: center;
    gap: 10px;
}

.hover-card-list li:last-child {
    border-bottom: none;
}

.hover-card-list-icon {
    color: #667eea;
    width: 20px;
}

.hover-card-footer {
    margin-top: 1.5rem;
    padding-top: 1rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
}

/* Backdrop overlay */
.hover-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 999;
    display: none;
}

.hover-backdrop.active {
    display: block;
}
        .nav-tabs {
            display: flex;
            gap: 0.8rem;
            overflow-x: auto;
            padding-bottom: 0.8rem;
            scrollbar-width: none;
        }

        .nav-tabs::-webkit-scrollbar {
            display: none;
        }

        .nav-tab {
            padding: 12px 24px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-normal);
            white-space: nowrap;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .nav-tab:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8));
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.5);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            padding: 1.5rem;
            background: var(--card-bg);
            border-radius: var(--border-radius);
            transition: all var(--transition-normal);
            cursor: pointer;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-sm);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: #667eea;
        }

        .stat-card .icon {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #667eea;
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
            margin: 2rem 0;
        }

        .chart-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--text-primary);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Buttons */
        .btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--glass-bg);
            color: var(--text-primary);
            border: 1px solid var(--glass-border);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            transform: translateY(-2px);
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
        }

        /* Table Styles */
        .table-container {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            overflow-x: auto;
            box-shadow: var(--shadow-sm);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            padding: 1rem;
            text-align: left;
            color: var(--text-primary);
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 1px;
            border-bottom: 2px solid var(--glass-border);
            background: rgba(255, 255, 255, 0.05);
        }

        td {
            padding: 1rem;
            color: var(--text-secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        tbody tr:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        /* Card Grid */
.card-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1.5rem;
    margin-top: 1.5rem;
}

.card-grid.grid-view {
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
}

.card-grid.list-view {
    grid-template-columns: 1fr;
}

.card-grid.compact-view {
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
}

        .item-card {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            transition: all var(--transition-normal);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
            border-color: #667eea;
        }

        .card-title {
            font-size: 1.2rem;
            margin-bottom: 0.8rem;
            color: var(--text-primary);
            font-weight: 700;
        }

        .card-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .card-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: var(--text-secondary);
            flex-wrap: wrap;
        }

        /* Badges */
        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .badge-active {
            background: rgba(79, 172, 254, 0.2);
            color: #4facfe;
            border: 1px solid rgba(79, 172, 254, 0.3);
        }

        .badge-completed {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            border: 1px solid rgba(46, 213, 115, 0.3);
        }

        .badge-published {
            background: rgba(240, 147, 251, 0.2);
            color: #f093fb;
            border: 1px solid rgba(240, 147, 251, 0.3);
        }

        /* Filter Controls */
        .filter-controls {
            display: flex;
            gap: 1rem;
            margin: 1.5rem 0;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-select {
            padding: 10px 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            min-width: 180px;
            font-size: 14px;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-input {
            padding: 10px 15px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            color: var(--text-primary);
            flex: 1;
            min-width: 250px;
            font-size: 14px;
        }

        .filter-input:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Modal for Institution Details */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            background: rgba(30, 41, 59, 0.75) !important; /* Dark with 75% opacity */
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-body {
            color: var(--text-secondary);
        }

        .modal-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .modal-stat {
            text-align: center;
            padding: 1rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .modal-stat-number {
            font-size: 1.8rem;
            font-weight: 800;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .modal-stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Layout Controls */
        .layout-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-radius: 15px;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-md);
        }

        .layout-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
            cursor: pointer;
            transition: all var(--transition-normal);
        }

        .layout-btn:hover {
            background: linear-gradient(135deg, #667eea, #764ba2);
            transform: scale(1.1);
        }

        .layout-btn.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 350px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #2ed573;
        }

        .notification.error {
            border-left: 4px solid #f5576c;
        }

        .notification.info {
            border-left: 4px solid #667eea;
        }

        /* Leaderboard */
        .leaderboard {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            transition: all var(--transition-normal);
        }

        .leaderboard-item:hover {
            transform: translateX(5px);
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .rank {
            font-size: 1.3rem;
            font-weight: 800;
            color: #667eea;
            min-width: 40px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .card-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
            
            .search-container {
                width: 100%;
                max-width: 100%;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-stats {
                grid-template-columns: 1fr;
            }
            
            .layout-controls {
                bottom: 10px;
                right: 10px;
            }
        }
        .hover-card {
    z-index: 9999 !important;
}

.hover-backdrop {
    z-index: 9998 !important;
}

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
            }
            
            h1 {
                font-size: 1.5rem;
            }
            
            .section-title {
                font-size: 1.4rem;
            }
            
            .stat-number {
                font-size: 1.8rem;
            }
            
            .charts-container {
                gap: 1rem;
            }
            
            .chart-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Add these cursor elements -->
    <div class="cursor"></div>
    <div class="cursor-follower"></div>
    
    <!-- Your existing animated gradient background -->
    <div class="animated-gradient-bg"></div>
    <!-- Login Modal -->
<div class="modal" id="loginModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Login</h3>
            <button class="modal-close" onclick="closeLoginModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="loginForm" onsubmit="login(event)">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" name="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" name="password" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeLoginModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>
            <div style="text-align: center; margin-top: 1rem;">
                <a href="#" onclick="showRegisterModal()">Don't have an account? Register</a>
            </div>
        </div>
    </div>
</div>
<!-- Advanced Search Modal -->
<div class="modal" id="advancedSearchModal">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 class="modal-title">Advanced Search</h3>
            <button class="modal-close" onclick="closeAdvancedSearchModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Search Type</label>
                    <select class="form-select" id="advancedSearchType" onchange="updateAdvancedSearchForm()">
                        <option value="researcher">Researchers</option>
                        <option value="project">Projects</option>
                        <option value="paper">Publications</option>
                        <option value="all">All</option>
                    </select>
                </div>
            </div>
            
            <!-- Researcher-specific filters -->
            <div id="researcherFilters" class="advanced-filters">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Institution</label>
                        <select class="form-select" id="researcherInstitutionFilter">
                            <option value="">Any Institution</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Academic Rank</label>
                        <select class="form-select" id="researcherRankFilter">
                            <option value="">Any Rank</option>
                            <option value="Professor">Professor</option>
                            <option value="Associate Professor">Associate Professor</option>
                            <option value="Assistant Professor">Assistant Professor</option>
                            <option value="Lecturer">Lecturer</option>
                            <option value="Postdoctoral Researcher">Postdoctoral Researcher</option>
                            <option value="PhD Student">PhD Student</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Min Citations</label>
                        <input type="number" class="form-input" id="minCitationsFilter" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Research Area</label>
                        <input type="text" class="form-input" id="researchAreaFilter" placeholder="e.g., Machine Learning">
                    </div>
                </div>
            </div>
            
            <!-- Project-specific filters -->
            <div id="projectFilters" class="advanced-filters" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" id="projectStatusFilter">
                            <option value="">Any Status</option>
                            <option value="Planning">Planning</option>
                            <option value="Active">Active</option>
                            <option value="Completed">Completed</option>
                            <option value="On Hold">On Hold</option>
                            <option value="Cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Min Team Size</label>
                        <input type="number" class="form-input" id="minTeamSizeFilter" min="1" value="1">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Date Range</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" class="form-input" id="projectStartDateFrom" style="flex: 1;">
                            <span>to</span>
                            <input type="date" class="form-input" id="projectStartDateTo" style="flex: 1;">
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Paper-specific filters -->
            <div id="paperFilters" class="advanced-filters" style="display: none;">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Publication Year</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" class="form-input" id="paperYearFrom" min="2000" max="2024" placeholder="From" style="flex: 1;">
                            <span>to</span>
                            <input type="number" class="form-input" id="paperYearTo" min="2000" max="2024" placeholder="To" style="flex: 1;">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Min Citations</label>
                        <input type="number" class="form-input" id="paperMinCitations" min="0" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Venue Type</label>
                        <select class="form-select" id="paperVenueTypeFilter">
                            <option value="">Any Type</option>
                            <option value="Journal">Journal</option>
                            <option value="Conference">Conference</option>
                            <option value="Workshop">Workshop</option>
                            <option value="Book">Book</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DOI Contains</label>
                        <input type="text" class="form-input" id="paperDoiFilter" placeholder="10.xxxx">
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeAdvancedSearchModal()">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="performAdvancedSearch()">Search</button>
            </div>
        </div>
    </div>
</div>


<!-- Register Modal -->
<div class="modal" id="registerModal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3 class="modal-title">Register</h3>
            <button class="modal-close" onclick="closeRegisterModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="registerForm" onsubmit="register(event)">
                <div class="form-group">
                    <label class="form-label">Username *</label>
                    <input type="text" class="form-input" name="username" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-input" name="email" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" name="full_name">
                </div>
                <div class="form-group">
                    <label class="form-label">Password *</label>
                    <input type="password" class="form-input" name="password" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Confirm Password *</label>
                    <input type="password" class="form-input" name="confirm_password" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeRegisterModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Register</button>
                </div>
            </form>
        </div>
    </div>
</div>
    <!-- Modal for Details (for institutions, researchers, projects, papers) -->
    <div class="modal" id="detailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>
<!-- Add/Edit Modal -->
<div class="modal" id="crudModal">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
        <div class="modal-header">
            <h3 class="modal-title" id="crudModalTitle">Add New</h3>
            <button class="modal-close" onclick="closeCrudModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="crudFormContainer">
                <!-- Forms will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal" id="confirmModal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 class="modal-title" id="confirmModalTitle">Confirm Action</h3>
            <button class="modal-close" onclick="closeConfirmModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirmModalMessage">Are you sure you want to perform this action?</p>
        </div>
        <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
            <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmActionBtn">Confirm</button>
        </div>
    </div>
</div>
    <!-- Notifications Container -->
    <div id="notificationsContainer"></div>
    <header>
        <div class="header-content">
            <h1><i class="fas fa-flask"></i> ResearchNet-X</h1>
            <div style="display: flex; align-items: center; gap: 1rem;">
    <div class="search-container">
        <input type="text" class="search-input" id="globalSearch" placeholder="Search researchers, projects, papers...">
        <span class="search-icon"><i class="fas fa-search"></i></span>
        <div class="search-results glass" id="searchResults" style="display: none;"></div>
    </div>
    
    <!-- Advanced Search Button -->
    <button class="btn-advanced-search" onclick="showAdvancedSearchModal()">
    <i class="fas fa-filter"></i> Advanced Search
</button>
    
    <button class="theme-toggle" id="themeToggle">
        <i class="fas fa-moon"></i>
    </button>
</div>
        </div>
    </header>

    <nav>
    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showSection('dashboard')">
            <i class="fas fa-chart-line"></i> Dashboard
        </button>
        <button class="nav-tab" onclick="showSection('institutions')">
            <i class="fas fa-university"></i> Institutions
        </button>
        <button class="nav-tab" onclick="showSection('researchers')">
            <i class="fas fa-user-graduate"></i> Researchers
        </button>
        <button class="nav-tab" onclick="showSection('projects')">
            <i class="fas fa-project-diagram"></i> Projects
        </button>
        <button class="nav-tab" onclick="showSection('papers')">
            <i class="fas fa-file-alt"></i> Publications
        </button>
        <button class="nav-tab" onclick="showSection('statistics')">
            <i class="fas fa-chart-bar"></i> Analytics
        </button>
    </div>
</nav>
    <div class="container">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <h2 class="section-title"><i class="fas fa-tachometer-alt"></i> Dashboard Overview</h2>
            <div class="dashboard-grid" id="dashboardStats">
                <!-- Stats will be loaded here -->
            </div>
<div class="action-buttons">
    <button class="btn btn-success" onclick="showAddCitationForm()">
        <i class="fas fa-plus"></i> Add Citation
    </button>
    <button class="btn btn-success" onclick="showAddFundingForm()">
        <i class="fas fa-plus"></i> Add Funding
    </button>
    <button class="btn btn-secondary" onclick="exportData('${entity}')" style="padding: 8px 16px; font-size: 13px;">
    <i class="fas fa-download"></i> Export
</button>
</div>
            <!-- Charts Section -->
            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Publications Per Year</h3>
                    <div id="publicationsChart" style="height: 250px; position: relative;">
                        <!-- Chart will be rendered here -->
                        <div style="display: flex; align-items: flex-end; justify-content: space-around; height: 200px; padding: 20px;">
                            <!-- Bars will be dynamically added -->
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Project Completion Status</h3>
                    <div id="completionChart" style="height: 250px; position: relative;">
                        <!-- Pie chart will be rendered here -->
                        <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                            <!-- Pie chart will be dynamically added -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leaderboard -->
            <h3 class="section-title" style="font-size: 1.4rem; margin-top: 2rem;">
                <i class="fas fa-trophy"></i> Top Researchers
            </h3>
            <div class="leaderboard" id="leaderboard">
                <!-- Leaderboard items will be loaded here -->
            </div>
        </div>

        <!-- Institutions Section -->
        <div id="institutions" class="section">
            <h2 class="section-title"><i class="fas fa-university"></i> Institutions</h2>
            
            <div class="filter-controls">
                <select class="filter-select" id="institutionTypeFilter" onchange="filterInstitutions()">
                    <option value="">All Types</option>
                    <option value="Public University">Public University</option>
                    <option value="Private University">Private University</option>
                    <option value="Research Center">Research Center</option>
                    <option value="Government">Government</option>
                </select>
                <input type="text" class="filter-input" id="institutionSearch" 
                       placeholder="Search by name or location..." 
                       oninput="filterInstitutions()">
                
            </div>
<!-- In each section (institutions, researchers, projects, papers) -->
<div class="action-buttons">
    <button class="btn btn-primary" onclick="refreshInstitutions()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
    <button class="btn btn-success" onclick="showAddInstitutionForm()">
        <i class="fas fa-plus"></i> Add Institution
    </button>
    <!-- Export button will be added dynamically by JavaScript -->
</div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Location</th>
                            <th>Type</th>
                            <th>Established</th>
                            <th>Website</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="institutionsBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Researchers Section -->
        <div id="researchers" class="section">
            <h2 class="section-title"><i class="fas fa-user-graduate"></i> Researchers</h2>
            
            <div class="action-buttons">
    <button class="btn btn-primary" onclick="refreshResearchers()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
    <button class="btn btn-success" onclick="showAddResearcherForm()">
        <i class="fas fa-plus"></i> Add Researcher
    </button>
</div>

            <div class="card-grid" id="researchersGrid">
                <!-- Data will be loaded here -->
            </div>
        </div>

        <!-- Projects Section -->
        <div id="projects" class="section">
            <h2 class="section-title"><i class="fas fa-project-diagram"></i> Research Projects</h2>
            
            <div class="action-buttons">
    <button class="btn btn-primary" onclick="refreshProjects()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
    <button class="btn btn-success" onclick="showAddProjectForm()">
        <i class="fas fa-plus"></i> Add Project
    </button>
</div>

            <div class="card-grid" id="projectsGrid">
                <!-- Data will be loaded here -->
            </div>
        </div>

        <!-- Papers Section -->
        <div id="papers" class="section">
            <h2 class="section-title"><i class="fas fa-file-alt"></i> Publications</h2>
            
            <div class="action-buttons">
    <button class="btn btn-primary" onclick="refreshPapers()">
        <i class="fas fa-sync-alt"></i> Refresh
    </button>
    <button class="btn btn-success" onclick="showAddPaperForm()">
        <i class="fas fa-plus"></i> Add Publication
    </button>

</div>

            <div class="card-grid" id="papersGrid">
                <!-- Data will be loaded here -->
            </div>
        </div>

        <!-- Statistics Section -->
        <div id="statistics" class="section">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Research Analytics</h2>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="refreshAnalytics()">
                    <i class="fas fa-sync-alt"></i> Refresh Analytics
                </button>
            </div>

            <div class="charts-container">
                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-calendar-alt"></i> Publications Timeline</h3>
                    <div id="timelineChart" style="height: 300px; padding: 20px;">
                        <!-- Timeline chart will be here -->
                    </div>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title"><i class="fas fa-fire"></i> Research Activity</h3>
                    <div id="activityChart" style="height: 300px; padding: 20px;">
                        <!-- Activity chart will be here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Layout Controls -->
<div class="layout-controls">
    <button class="layout-btn active" onclick="setGridView()" title="Grid View">
        <i class="fas fa-th-large"></i>
    </button>
    <button class="layout-btn" onclick="setListView()" title="List View">
        <i class="fas fa-list"></i>
    </button>
    <button class="layout-btn" onclick="setCompactView()" title="Compact View">
        <i class="fas fa-th"></i>
    </button>
    <button class="layout-btn" onclick="resetLayout()" title="Reset Layout">
        <i class="fas fa-redo"></i>
    </button>
</div>
    <script>

        // Global state

        let currentSection = 'dashboard';
        let currentViewMode = 'grid';
        let currentEditId = null;
        let currentEditType = null;
        let currentFilters = {
            institutions: {
                type: '',
                search: ''
            }
        };
        

        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
// Add this function BEFORE initializeApp()


// ==================== CURSOR AND CLICK EFFECTS ====================

let mouseX = 0;
let mouseY = 0;
let cursor = null;
let follower = null;

function setupCustomCursor() {
    cursor = document.querySelector('.cursor');
    follower = document.querySelector('.cursor-follower');

    if (!cursor || !follower) {
        console.error('Cursor elements not found');
        return;
    }

    // Move cursor with mouse
    document.addEventListener('mousemove', (e) => {
        mouseX = e.clientX;
        mouseY = e.clientY;
        
        if (cursor) {
            cursor.style.left = mouseX + 'px';
            cursor.style.top = mouseY + 'px';
        }
        
        if (follower) {
            // Smooth follow with delay
            setTimeout(() => {
                follower.style.left = mouseX + 'px';
                follower.style.top = mouseY + 'px';
            }, 50);
        }
    });

    // Cursor effects on interactive elements
    const interactiveElements = document.querySelectorAll(
        'button, a, .item-card, .nav-tab, .stat-card, .btn, input, select, .theme-toggle, .layout-btn, .filter-select, .filter-input, .search-input, .modal-close, .form-input, .form-select, .form-textarea, .badge'
    );
    
    interactiveElements.forEach(el => {
        el.addEventListener('mouseenter', () => {
            if (cursor) cursor.style.transform = 'scale(1.5)';
            if (follower) {
                follower.style.transform = 'scale(1.2)';
                follower.style.borderColor = '#667eea';
            }
        });
        
        el.addEventListener('mouseleave', () => {
            if (cursor) cursor.style.transform = 'scale(1)';
            if (follower) {
                follower.style.transform = 'scale(1)';
                follower.style.borderColor = 'rgba(102, 126, 234, 0.3)';
            }
        });
    });

    // Click effect for entire document
    document.addEventListener('click', (e) => {
        if (cursor) {
            cursor.style.transform = 'scale(0.8)';
            setTimeout(() => {
                cursor.style.transform = 'scale(1)';
            }, 100);
        }
        
        if (follower) {
            follower.style.transform = 'scale(1.3)';
            follower.style.opacity = '0.7';
            setTimeout(() => {
                follower.style.transform = 'scale(1)';
                follower.style.opacity = '1';
            }, 200);
        }
        
        // Create particle burst at click location
        createParticleBurst(e.clientX, e.clientY, 10);
        
        // Create ripple effect
        createRippleEffect(e.clientX, e.clientY);
    });

    console.log('Custom cursor initialized');
}

// Particle Burst Effect
function createParticleBurst(x, y, count = 10) {
    // Don't create particles on mobile
    if (window.innerWidth <= 768) return;
    
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle-burst';
        
        const angle = Math.random() * Math.PI * 2;
        const velocity = 2 + Math.random() * 3;
        const size = 2 + Math.random() * 4;
        
        particle.style.width = size + 'px';
        particle.style.height = size + 'px';
        particle.style.left = x + 'px';
        particle.style.top = y + 'px';
        particle.style.position = 'fixed';
        particle.style.zIndex = '99999';
        particle.style.pointerEvents = 'none';
        particle.style.borderRadius = '50%';
        
        // Random color from gradient
        const colors = [
            '#667eea', '#764ba2', '#f093fb', '#f5576c', 
            '#4facfe', '#00f2fe', '#fa709a', '#fee140'
        ];
        particle.style.background = colors[Math.floor(Math.random() * colors.length)];
        
        document.body.appendChild(particle);
        
        // Animate the particle
        const animation = particle.animate([
            {
                transform: 'translate(0, 0) scale(1)',
                opacity: 1
            },
            {
                transform: `translate(${Math.cos(angle) * velocity * 50}px, ${Math.sin(angle) * velocity * 50}px) scale(0)`,
                opacity: 0
            }
        ], {
            duration: 800,
            easing: 'cubic-bezier(0.1, 0.8, 0.9, 0.2)'
        });
        
        animation.onfinish = () => {
            if (particle && particle.parentNode) {
                particle.remove();
            }
        };
    }
}

// Ripple Effect
function createRippleEffect(x, y) {
    // Don't create ripples on mobile
    if (window.innerWidth <= 768) return;
    
    const ripple = document.createElement('div');
    ripple.style.position = 'fixed';
    ripple.style.width = '40px';
    ripple.style.height = '40px';
    ripple.style.left = (x - 20) + 'px';
    ripple.style.top = (y - 20) + 'px';
    ripple.style.borderRadius = '50%';
    ripple.style.border = '2px solid rgba(102, 126, 234, 0.5)';
    ripple.style.zIndex = '99998';
    ripple.style.pointerEvents = 'none';
    ripple.style.transform = 'scale(0)';
    
    document.body.appendChild(ripple);
    
    // Animate the ripple
    const animation = ripple.animate([
        {
            transform: 'scale(0)',
            opacity: 1,
            borderWidth: '2px'
        },
        {
            transform: 'scale(3)',
            opacity: 0,
            borderWidth: '0px'
        }
    ], {
        duration: 600,
        easing: 'ease-out'
    });
    
    animation.onfinish = () => {
        if (ripple && ripple.parentNode) {
            ripple.remove();
        }
    };
}

// Setup click effects for interactive elements
function setupClickEffects() {
    // Add scale animation to all clickable elements
    const clickableElements = document.querySelectorAll(
        'button, .btn, .item-card, .stat-card, .nav-tab, .theme-toggle, .layout-btn, .modal-close, .search-icon, .action-buttons button'
    );
    
    clickableElements.forEach(element => {
        element.addEventListener('click', function(e) {
            // Prevent double bubbling
            e.stopPropagation();
            
            // Get element center position for particles
            const rect = this.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // Create particles at element center
            createParticleBurst(centerX, centerY, 8);
            
            // Add a subtle scale animation to the clicked element
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
}

// Keyboard navigation for tabs
function setupKeyboardNavigation() {
    document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + number for tab switching
        if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '6') {
            e.preventDefault();
            const tabs = document.querySelectorAll('.nav-tab');
            const index = parseInt(e.key) - 1;
            if (tabs[index]) {
                tabs[index].click();
            }
        }
        
        // Arrow keys for navigation
        if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
            const tabs = document.querySelectorAll('.nav-tab');
            const currentIndex = Array.from(tabs).findIndex(tab => tab.classList.contains('active'));
            let nextIndex;
            
            if (e.key === 'ArrowRight') {
                nextIndex = (currentIndex + 1) % tabs.length;
            } else {
                nextIndex = (currentIndex - 1 + tabs.length) % tabs.length;
            }
            
            if (tabs[nextIndex]) {
                tabs[nextIndex].click();
                tabs[nextIndex].focus();
            }
        }
    });
}

async function initializeApp() {
    // Setup theme FIRST
    setupTheme();
    
    // Setup search
    setupSearch();

    setupKeyboardNavigation();
    
    // Show loading notification
    showNotification('Loading Research Database...', 'info');
    
    // Setup cursor and click effects - must be after DOM is ready
    setTimeout(() => {
        setupCustomCursor();
        setupClickEffects();
    }, 100);
        
    try {
        // Load all data automatically
        await loadAllData();
        
        // Show welcome notification
        setTimeout(() => {
            showNotification('ResearchNet-X Dashboard loaded successfully!', 'success');
        }, 1000);
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showNotification('Failed to load initial data', 'error');
    }
    
    // Setup layout controls
    setupLayoutControls();
    
    // Add event listener for page visibility changes
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) {
            // Page became visible again, refresh data
            refreshCurrentSection();
        }
    });
    
    // Add periodic refresh (every 5 minutes)
    setInterval(refreshCurrentSection, 5 * 60 * 1000);
}
// New function to load all data
async function loadAllData() {
    // Create loading states
    showLoadingState();
    
    try {
        // Load dashboard data first
        await loadDashboard();
        
        // Pre-load other sections in background
        Promise.allSettled([
            loadInstitutions(),
            loadResearchers(),
            loadProjects(),
            loadPapers()
        ]).then(results => {
            // Check for any failures
            const failures = results.filter(r => r.status === 'rejected');
            if (failures.length > 0) {
                console.warn('Some data failed to load:', failures);
            }
            
            // Hide loading state
            hideLoadingState();
            
            // Re-setup click effects after data loads (for dynamically created elements)
            setTimeout(() => {
                setupClickEffects();
            }, 500);
        });
        
    } catch (error) {
        hideLoadingState();
        throw error;
    }
}
// Function to refresh current section
function refreshCurrentSection() {
    if (currentSection) {
        showNotification(`Refreshing ${currentSection} data...`, 'info');
        loadSectionData(currentSection);
    }
}

// Add loading state functions
function showLoadingState() {
    // Create or show loading overlay
    let loadingOverlay = document.getElementById('loadingOverlay');
    if (!loadingOverlay) {
        loadingOverlay = document.createElement('div');
        loadingOverlay.id = 'loadingOverlay';
        loadingOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        `;
        
        const spinner = document.createElement('div');
        spinner.style.cssText = `
            width: 50px;
            height: 50px;
            border: 3px solid var(--glass-border);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        `;
        
        const text = document.createElement('div');
        text.textContent = 'Loading Research Data...';
        text.style.cssText = `
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
        `;
        
        loadingOverlay.appendChild(spinner);
        loadingOverlay.appendChild(text);
        
        // Add CSS for spinner animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(loadingOverlay);
    } else {
        loadingOverlay.style.display = 'flex';
    }
}

function hideLoadingState() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
    }
}
// Function to refresh cursor effects when new elements are added
function refreshCursorEffects() {
    if (typeof setupCustomCursor === 'function') {
        setupCustomCursor();
    }
    if (typeof setupClickEffects === 'function') {
        setupClickEffects();
    }
}

// Call this whenever you add new interactive elements dynamically
function updateCursorForNewElements() {
    setTimeout(refreshCursorEffects, 100);
}
// Add this function to update all dropdowns when theme changes
function updateSelectElementsTheme() {
    const selects = document.querySelectorAll('.form-select, .filter-select');
    selects.forEach(select => {
        // Force reflow to apply styles
        select.style.display = 'none';
        select.offsetHeight; // Trigger reflow
        select.style.display = '';
        
        // Force CSS update
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        if (isDark) {
            select.style.backgroundColor = 'var(--card-bg)';
            select.style.color = 'var(--text-primary)';
            select.style.borderColor = 'var(--glass-border)';
        }
    });
}

// Update the toggleTheme function to call this:
function toggleTheme() {
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    if (isDark) {
        document.documentElement.setAttribute('data-theme', 'light');
        document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
        showNotification('Switched to Light Mode', 'info');
    } else {
        document.documentElement.setAttribute('data-theme', 'dark');
        document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
        showNotification('Switched to Dark Mode', 'info');
    }
    
    // Update dropdown styles after theme change
    setTimeout(updateSelectElementsTheme, 100);
}

// Also update dropdowns when modals are opened
function showEditResearcherForm(id) {
    // Your existing code...
    
    // After showing the modal, update dropdowns
    setTimeout(() => {
        updateSelectElementsTheme();
    }, 200);
}

// Do the same for other form showing functions
function showAddResearcherForm() {
    // Your existing code...
    
    setTimeout(() => {
        updateSelectElementsTheme();
    }, 200);
}
// Add this to your data loading functions
// For example, modify loadResearchers():
async function loadResearchers() {
    try {
        const response = await fetch('/api/researchers');
        const researchers = await response.json();
        
        const grid = document.getElementById('researchersGrid');
        if (researchers.length === 0) {
            grid.innerHTML = `
                <div class="item-card" style="text-align: center; padding: 3rem;">
                    <i class="fas fa-user-graduate" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                    <div style="color: var(--text-secondary);">No researchers found</div>
                </div>
            `;
        } else {
            grid.innerHTML = researchers.map(res => `
                <div class="item-card">
                    <div class="card-title">${res.full_name}</div>
                    <div class="card-subtitle">
                        <i class="fas fa-envelope"></i> ${res.email || 'No email'}
                    </div>
                    <div class="card-meta">
                        <span class="badge badge-active">
                            <i class="fas fa-graduation-cap"></i> ${res.academic_rank || 'Not specified'}
                        </span>
                        <span><i class="fas fa-university"></i> ${res.institution_name || 'Unknown'}</span>
                    </div>
                    <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                        <i class="fas fa-id-card"></i> ${res.orcid_id || 'No ORCID'}
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
                                onclick="showDetailsModal('researcher', ${res.researcher_id})">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button class="btn btn-warning" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
                                onclick="showEditResearcherForm(${res.researcher_id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-danger" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
                                onclick="confirmDelete('researcher', ${res.researcher_id}, '${res.full_name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Update cursor effects for newly created elements
        updateCursorForNewElements();
        addExportButtons();
        
    } catch (error) {
        console.error('Error loading researchers:', error);
        showNotification('Failed to load researchers', 'error');
    }
}
// Update the showSection function to automatically refresh
function showSection(sectionName) {
    // If clicking on already active tab, just refresh
    if (currentSection === sectionName) {
        refreshCurrentSection();
        return;
    }
    
    // Store the event target if it exists
    const clickedTab = event && event.target ? event.target.closest('.nav-tab') : null;
    
    // Remove active from all sections with animation
    document.querySelectorAll('.section').forEach(section => {
        if (section.classList.contains('active')) {
            section.style.opacity = '0';
            section.style.transform = 'translateY(20px)';
            setTimeout(() => {
                section.classList.remove('active');
                section.style.opacity = '';
                section.style.transform = '';
            }, 300);
        }
    });
    
    // Remove active from all tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Show selected section with animation
    const targetSection = document.getElementById(sectionName);
    if (targetSection) {
        targetSection.classList.add('active');
        
        // Trigger animation
        setTimeout(() => {
            targetSection.style.opacity = '1';
            targetSection.style.transform = 'translateY(0)';
        }, 50);
    }
    
    // Mark tab as active
    if (clickedTab) {
        clickedTab.classList.add('active');
    } else {
        // Find the tab that corresponds to this section
        const tab = document.querySelector(`.nav-tab[onclick*="${sectionName}"]`);
        if (tab) tab.classList.add('active');
    }
    
    currentSection = sectionName;
    
    // Smooth scroll to section
    setTimeout(() => {
        if (targetSection) {
            targetSection.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'start' 
            });
        }
    }, 100);
    
    // Load data for the section
    loadSectionData(sectionName);
}
// Update loadSectionData to show loading state
async function loadSectionData(sectionName) {
    try {
        // Show loading for the specific section
        const section = document.getElementById(sectionName);
        if (section) {
            const loadingIndicator = section.querySelector('.section-loading');
            if (!loadingIndicator) {
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'section-loading';
                loadingDiv.style.cssText = `
                    text-align: center;
                    padding: 20px;
                    color: var(--text-secondary);
                `;
                loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                section.insertBefore(loadingDiv, section.firstChild);
            }
        }
        switch(sectionName) {
            case 'dashboard':
                await loadDashboard();
                break;
            case 'institutions':
                await loadInstitutions();
                break;
            case 'researchers':
                await loadResearchers();
                break;
            case 'projects':
                await loadProjects();
                break;
            case 'papers':
                await loadPapers();
                break;
            case 'statistics':
                await loadStatistics();
                break;
        }
        
        // Hide loading indicator
        const loadingIndicator = document.querySelector(`#${sectionName} .section-loading`);
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
        
    } catch (error) {
        console.error(`Error loading ${sectionName}:`, error);
        showNotification(`Failed to load ${sectionName} data`, 'error');
        
        // Hide loading indicator on error too
        const loadingIndicator = document.querySelector(`#${sectionName} .section-loading`);
        if (loadingIndicator) {
            loadingIndicator.remove();
        }
    }
}
// Function to ensure default author roles exist
async function initializeAuthorRoles() {
    try {
        // Check if 'Author' role exists
        const [existing] = await promisePool.execute(
            "SELECT author_role_id FROM AUTHOR_ROLE WHERE role_name = 'Author'"
        );
        
        if (existing.length === 0) {
            // Create default author roles
            await promisePool.execute(
                `INSERT INTO AUTHOR_ROLE (role_name, role_description) VALUES 
                 ('Author', 'Primary author'),
                 ('Co-Author', 'Contributing author'),
                 ('Corresponding Author', 'Corresponding author'),
                 ('First Author', 'First listed author')`
            );
            console.log('Default author roles created');
        }
    } catch (error) {
        console.error('Error initializing author roles:', error);
    }
}

// Call this after database connection
promisePool.getConnection()
    .then(connection => {
        console.log('Successfully connected to research_db database');
        connection.release();
        initializeAuthorRoles(); // Initialize author roles
    })
    .catch(err => {
        console.error('Database connection failed:', err.message);
    });
        // Export Functions
async function exportData(entityType) {
    try {
        const format = 'csv'; // Could make this selectable
        const response = await fetch(`/api/export/${entityType}?format=${format}`);
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${entityType}_${new Date().toISOString().split('T')[0]}.${format}`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showNotification(`${entityType} exported successfully`, 'success');
        } else {
            showNotification('Export failed', 'error');
        }
    } catch (error) {
        console.error('Export error:', error);
        showNotification('Export failed', 'error');
    }
}

// Add export button to each section's action buttons
function addExportButtons() {
    const sections = {
        'institutions': 'institutions',
        'researchers': 'researchers',
        'projects': 'projects',
        'papers': 'papers'
    };
    
    Object.entries(sections).forEach(([sectionId, entity]) => {
        const section = document.getElementById(sectionId);
        if (section) {
            const actionButtons = section.querySelector('.action-buttons');
            if (actionButtons) {
                // Remove any existing export button
                const existingExportBtn = actionButtons.querySelector('.export-btn');
                if (existingExportBtn) {
                    existingExportBtn.remove();
                }
                
                // Add new export button
                const exportBtn = document.createElement('button');
                exportBtn.className = 'btn btn-secondary export-btn';
                exportBtn.style.cssText = 'padding: 8px 16px; font-size: 13px;';
                exportBtn.innerHTML = '<i class="fas fa-download"></i> Export';
                exportBtn.onclick = () => exportData(entity);
                actionButtons.appendChild(exportBtn);
            }
        }
    });
}
// Add this to your JavaScript functions section
function addDepartment() {
    const container = document.getElementById('departmentsContainer');
    const departmentCount = container.querySelectorAll('.department-entry').length;
    
    const newEntry = document.createElement('div');
    newEntry.className = 'department-entry';
    newEntry.style.cssText = 'margin-bottom: 1rem;';
    newEntry.innerHTML = `
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label class="form-label">Department Name *</label>
                <input type="text" class="form-input department-name" name="departments[]" placeholder="e.g., Computer Science" required>
            </div>
            <div class="form-group" style="flex: 1;">
                <label class="form-label">Department Code</label>
                <input type="text" class="form-input department-code" name="department_codes[]" placeholder="e.g., CS">
            </div>
            <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                        style="width: 40px; height: 40px; padding: 0;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(newEntry);
    
    // Show remove button on first entry if not already shown
    if (departmentCount === 1) {
        const firstRemoveBtn = container.querySelector('.department-entry:first-child .btn-danger');
        if (firstRemoveBtn) {
            firstRemoveBtn.style.display = 'block';
        }
    }
}

function removeDepartment(button) {
    const entry = button.closest('.department-entry');
    if (entry) {
        entry.remove();
        
        // Hide remove button if only one entry remains
        const container = document.getElementById('departmentsContainer');
        const remainingEntries = container.querySelectorAll('.department-entry');
        if (remainingEntries.length === 1) {
            const removeBtn = remainingEntries[0].querySelector('.btn-danger');
            if (removeBtn) {
                removeBtn.style.display = 'none';
            }
        }
    }
}
// Call this in initializeApp()
addExportButtons();
// Report Generation Functions
async function generateResearcherReport(researcherId) {
    try {
        const response = await fetch(`/api/reports/researcher/${researcherId}`);
        const report = await response.json();
        
        // Create a modal to display the report
        const modalHTML = `
            <div class="modal-header">
                <h3 class="modal-title">
                    <i class="fas fa-user-graduate"></i> ${report.researcher.full_name} - Research Report
                </h3>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 10px;">Profile Summary</h4>
                    <div class="modal-stats">
                        <div class="modal-stat">
                            <div class="modal-stat-number">${report.metrics.total_publications}</div>
                            <div class="modal-stat-label">Publications</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-number">${report.metrics.total_citations}</div>
                            <div class="modal-stat-label">Citations</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-number">${report.metrics.total_projects}</div>
                            <div class="modal-stat-label">Projects</div>
                        </div>
                        <div class="modal-stat">
                            <div class="modal-stat-number">${report.researcher.h_index || 'N/A'}</div>
                            <div class="modal-stat-label">H-Index</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 20px; margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="exportData('${entity}')" style="padding: 8px 16px; font-size: 13px;">
    <i class="fas fa-download"></i> Export
</button>
                    <button class="btn btn-secondary" onclick="printResearcherReport()">
                        <i class="fas fa-print"></i> Print
                    </button>
                </div>
            </div>
        `;
        
        // Create a new modal for the report
        const reportModal = document.createElement('div');
        reportModal.className = 'modal active';
        reportModal.id = 'reportModal';
        reportModal.innerHTML = `
            <div class="modal-content" style="max-width: 800px; max-height: 90vh;">
                ${modalHTML}
            </div>
        `;
        
        document.body.appendChild(reportModal);
        
    } catch (error) {
        console.error('Error generating report:', error);
        showNotification('Failed to generate report', 'error');
    }
}

function closeReportModal() {
    const modal = document.getElementById('reportModal');
    if (modal) {
        modal.remove();
    }
}

async function exportResearcherReport(researcherId) {
    try {
        // In a real implementation, you would generate a PDF
        // For now, we'll create a comprehensive text report
        const response = await fetch(`/api/reports/researcher/${researcherId}`);
        const report = await response.json();
        
        let reportText = `RESEARCHER REPORT\n`;
        reportText += `================\n\n`;
        reportText += `Name: ${report.researcher.full_name}\n`;
        reportText += `Email: ${report.researcher.email}\n`;
        reportText += `Institution: ${report.researcher.institution}\n`;
        reportText += `Department: ${report.researcher.department}\n`;
        reportText += `\nMETRICS:\n`;
        reportText += `Publications: ${report.metrics.total_publications}\n`;
        reportText += `Citations: ${report.metrics.total_citations}\n`;
        reportText += `Projects: ${report.metrics.total_projects}\n`;
        reportText += `H-Index: ${report.researcher.h_index || 'N/A'}\n`;
        
        reportText += `\nPUBLICATIONS:\n`;
        report.publications.forEach((pub, index) => {
            reportText += `${index + 1}. ${pub.title}\n`;
            reportText += `   Venue: ${pub.venue}\n`;
            reportText += `   Date: ${pub.publication_date}\n`;
            reportText += `   Citations: ${pub.citation_count}\n`;
            reportText += `   DOI: ${pub.doi || 'N/A'}\n\n`;
        });
        
        // Create and download text file
        const blob = new Blob([reportText], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `researcher_report_${report.researcher.full_name.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Report exported successfully', 'success');
        
    } catch (error) {
        console.error('Export error:', error);
        showNotification('Failed to export report', 'error');
    }
}

function printResearcherReport() {
    window.print();
}

// Add report button to researcher cards
function addReportButtons() {
    document.querySelectorAll('.item-card').forEach(card => {
        if (!card.querySelector('.report-btn')) {
            const reportBtn = document.createElement('button');
            reportBtn.className = 'btn btn-info report-btn';
            reportBtn.style.cssText = 'padding: 5px 10px; font-size: 12px; margin-top: 5px;';
            reportBtn.innerHTML = '<i class="fas fa-file-alt"></i> Report';
            reportBtn.onclick = (e) => {
                e.stopPropagation();
                const researcherId = card.dataset.researcherId || 
                                   card.querySelector('button[onclick*="showEditResearcherForm"]')
                                      ?.onclick?.toString()?.match(/\d+/)?.[0];
                if (researcherId) {
                    generateResearcherReport(researcherId);
                }
            };
            card.appendChild(reportBtn);
        }
    });
}

// Update loadResearchers function to add data attribute
function updateLoadResearchers() {
    // In the map function where you create researcher cards, add:
    // data-researcher-id="${res.researcher_id}"
}
        // Advanced Search Functions
async function showAdvancedSearchModal() {
    // Load institutions for the filter dropdown
    const institutions = await getInstitutions();
    const institutionOptions = institutions.map(inst => 
        `<option value="${inst.institution_id}">${inst.name}</option>`
    ).join('');
    
    document.getElementById('researcherInstitutionFilter').innerHTML = 
        '<option value="">Any Institution</option>' + institutionOptions;
    
    document.getElementById('advancedSearchModal').classList.add('active');
}

function closeAdvancedSearchModal() {
    document.getElementById('advancedSearchModal').classList.remove('active');
}

function updateAdvancedSearchForm() {
    const type = document.getElementById('advancedSearchType').value;
    
    // Hide all filters first
    document.querySelectorAll('.advanced-filters').forEach(el => {
        el.style.display = 'none';
    });
    
    // Show relevant filters
    if (type === 'researcher' || type === 'all') {
        document.getElementById('researcherFilters').style.display = 'block';
    }
    if (type === 'project' || type === 'all') {
        document.getElementById('projectFilters').style.display = 'block';
    }
    if (type === 'paper' || type === 'all') {
        document.getElementById('paperFilters').style.display = 'block';
    }
}

async function performAdvancedSearch() {
    const searchType = document.getElementById('advancedSearchType').value;
    let results = [];
    
    try {
        // Build query based on search type
        if (searchType === 'researcher' || searchType === 'all') {
            const params = new URLSearchParams();
            
            const institutionId = document.getElementById('researcherInstitutionFilter').value;
            const rank = document.getElementById('researcherRankFilter').value;
            const minCitations = document.getElementById('minCitationsFilter').value;
            const researchArea = document.getElementById('researchAreaFilter').value;
            
            if (institutionId) params.append('institution_id', institutionId);
            if (rank) params.append('academic_rank', rank);
            if (minCitations) params.append('min_citations', minCitations);
            if (researchArea) params.append('research_area', researchArea);
            
            const response = await fetch(`/api/researchers/advanced-search?${params.toString()}`);
            if (searchType === 'researcher') {
                results = await response.json();
            } else {
                const researcherResults = await response.json();
                results.push(...researcherResults.map(r => ({
                    ...r,
                    type: 'researcher'
                })));
            }
        }
        
        if (searchType === 'project' || searchType === 'all') {
            const params = new URLSearchParams();
            
            const status = document.getElementById('projectStatusFilter').value;
            const minTeamSize = document.getElementById('minTeamSizeFilter').value;
            const startDateFrom = document.getElementById('projectStartDateFrom').value;
            const startDateTo = document.getElementById('projectStartDateTo').value;
            
            if (status) params.append('status', status);
            if (minTeamSize) params.append('min_team_size', minTeamSize);
            if (startDateFrom) params.append('start_date_from', startDateFrom);
            if (startDateTo) params.append('start_date_to', startDateTo);
            
            const response = await fetch(`/api/projects/advanced-search?${params.toString()}`);
            if (searchType === 'project') {
                results = await response.json();
            } else {
                const projectResults = await response.json();
                results.push(...projectResults.map(p => ({
                    ...p,
                    type: 'project'
                })));
            }
        }
        
        if (searchType === 'paper' || searchType === 'all') {
            const params = new URLSearchParams();
            
            const yearFrom = document.getElementById('paperYearFrom').value;
            const yearTo = document.getElementById('paperYearTo').value;
            const minCitations = document.getElementById('paperMinCitations').value;
            const venueType = document.getElementById('paperVenueTypeFilter').value;
            const doiContains = document.getElementById('paperDoiFilter').value;
            
            if (yearFrom) params.append('year_from', yearFrom);
            if (yearTo) params.append('year_to', yearTo);
            if (minCitations) params.append('min_citations', minCitations);
            if (venueType) params.append('venue_type', venueType);
            if (doiContains) params.append('doi_contains', doiContains);
            
            const response = await fetch(`/api/papers/advanced-search?${params.toString()}`);
            if (searchType === 'paper') {
                results = await response.json();
            } else {
                const paperResults = await response.json();
                results.push(...paperResults.map(p => ({
                    ...p,
                    type: 'paper'
                })));
            }
        }
        
        // Display results
        displayAdvancedSearchResults(results, searchType);
        
    } catch (error) {
        console.error('Advanced search error:', error);
        showNotification('Search failed', 'error');
    }
}

function displayAdvancedSearchResults(results, searchType) {
    const modalBody = document.querySelector('#advancedSearchModal .modal-body');
    
    if (results.length === 0) {
        modalBody.innerHTML += `
            <div style="margin-top: 20px; padding: 20px; text-align: center; color: var(--text-secondary);">
                <i class="fas fa-search" style="font-size: 2rem; margin-bottom: 10px;"></i>
                <div>No results found</div>
            </div>
        `;
        return;
    }
    
    let resultsHTML = `
        <div style="margin-top: 20px;">
            <h4 style="color: var(--text-primary); margin-bottom: 15px;">
                Search Results (${results.length} found)
            </h4>
            <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
    `;
    
    results.forEach((item, index) => {
        const icon = {
            researcher: 'fas fa-user-graduate',
            project: 'fas fa-project-diagram',
            paper: 'fas fa-file-alt'
        }[item.type || searchType] || 'fas fa-search';
        
        const color = {
            researcher: '#667eea',
            project: '#4facfe',
            paper: '#f093fb'
        }[item.type || searchType] || '#667eea';
        
        resultsHTML += `
            <div class="item-card" style="margin-bottom: 10px; cursor: pointer;" 
                 onclick="navigateToAdvancedSearchResult('${item.type || searchType}', ${item.researcher_id || item.project_id || item.output_id || item.id})">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="${icon}" style="color: ${color}; font-size: 1.2rem;"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; color: var(--text-primary);">
                            ${item.full_name || item.project_title || item.title || item.name}
                        </div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                            ${item.email || item.project_status || item.manuscript_status || ''}
                            ${item.citation_count ? `  ${item.citation_count} citations` : ''}
                            ${item.publication_date ? `  ${new Date(item.publication_date).getFullYear()}` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    resultsHTML += `
            </div>
        </div>
    `;
    
    // Insert results after the form
    const formActions = modalBody.querySelector('.form-actions');
    if (modalBody.querySelector('.search-results-container')) {
        modalBody.querySelector('.search-results-container').remove();
    }
    formActions.insertAdjacentHTML('beforebegin', `<div class="search-results-container">${resultsHTML}</div>`);
}

function navigateToAdvancedSearchResult(type, id) {
    closeAdvancedSearchModal();
    showSection(type === 'researcher' ? 'researchers' : 
                type === 'project' ? 'projects' : 
                type === 'paper' ? 'papers' : 'dashboard');
    
    setTimeout(() => {
        showDetailsModal(type, id);
    }, 500);
}
        // Theme Management (unchanged)
        function setupTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            if (prefersDark) {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            themeToggle.addEventListener('click', toggleTheme);
        }

        function toggleTheme() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            if (isDark) {
                document.documentElement.setAttribute('data-theme', 'light');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                showNotification('Switched to Light Mode', 'info');
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').innerHTML = '<i class="fas fa-moon"></i>';
                showNotification('Switched to Dark Mode', 'info');
            }
        }

        // Search functionality (unchanged)
        function setupSearch() {
            const searchInput = document.getElementById('globalSearch');
            const searchResults = document.getElementById('searchResults');
            
            searchInput.addEventListener('input', debounce(async function() {
                const query = this.value.trim();
                if (query.length < 2) {
                    searchResults.style.display = 'none';
                    return;
                }
                
                try {
                    const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                    const results = await response.json();
                    
                    if (results.length === 0) {
                        searchResults.innerHTML = '<div style="padding: 15px; color: var(--text-secondary);">No results found</div>';
                        searchResults.style.display = 'block';
                        return;
                    }
                    
                    const html = results.map(result => {
                        const icon = {
                            researcher: 'fas fa-user-graduate',
                            project: 'fas fa-project-diagram',
                            paper: 'fas fa-file-alt',
                            institution: 'fas fa-university'
                        }[result.type] || 'fas fa-search';
                        
                        return `
                            <div class="search-result-item" 
                                 style="padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer;"
                                 onclick="navigateToSearchResult('${result.type}', ${result.id})">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <i class="${icon}" style="color: #667eea;"></i>
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${result.name}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                            ${result.type.charAt(0).toUpperCase() + result.type.slice(1)}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    searchResults.innerHTML = html;
                    searchResults.style.display = 'block';
                } catch (error) {
                    console.error('Search error:', error);
                }
            }, 300));
            
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.style.display = 'none';
                }
            });
        }

        function navigateToSearchResult(type, id) {
            const sectionMap = {
                researcher: 'researchers',
                project: 'projects',
                paper: 'papers',
                institution: 'institutions'
            };
            
            showSection(sectionMap[type]);
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('globalSearch').value = '';
            
            // Show the details modal for the selected item
            setTimeout(() => {
                showDetailsModal(type, id);
            }, 500);
        }

        // Section Navigation
        function showSection(sectionName) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const targetSection = document.getElementById(sectionName);
            targetSection.classList.add('active');
            
            if (event && event.target) {
                event.target.classList.add('active');
            }
            
            currentSection = sectionName;
            
            setTimeout(() => {
                targetSection.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'start' 
                });
            }, 50);
            
            loadSectionData(sectionName);
        }

async function loadSectionData(sectionName) {
    console.log(`Loading data for: ${sectionName}`);
    
    // Add loading state to the section
    const section = document.getElementById(sectionName);
    if (section) {
        // Remove any existing loading indicator
        const existingLoader = section.querySelector('.section-loader');
        if (existingLoader) existingLoader.remove();
        
        // Add new loading indicator
        const loader = document.createElement('div');
        loader.className = 'section-loader';
        loader.style.cssText = `
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        `;
        loader.innerHTML = `
            <div style="font-size: 3rem; margin-bottom: 1rem;">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
            <div>Loading ${sectionName} data...</div>
        `;
        section.appendChild(loader);
    }
    
    try {
        switch(sectionName) {
            case 'dashboard':
                await loadDashboard();
                break;
            case 'institutions':
                await loadInstitutions();
                break;
            case 'researchers':
                await loadResearchers();
                break;
            case 'projects':
                await loadProjects();
                break;
            case 'papers':
                await loadPapers();
                break;
            case 'statistics':
                await loadStatistics();
                break;
        }
        
        // Remove loading indicator
        const loader = document.querySelector(`#${sectionName} .section-loader`);
        if (loader) loader.remove();
        
    } catch (error) {
        console.error(`Error loading ${sectionName}:`, error);
        showNotification(`Failed to load ${sectionName} data`, 'error');
        
        // Remove loading indicator on error too
        const loader = document.querySelector(`#${sectionName} .section-loader`);
        if (loader) loader.remove();
    }
}

async function loadDepartments(institutionId, selectedDeptId = '') {
    if (!institutionId) return;
    
    try {
        const response = await fetch(`/api/departments?institution_id=${institutionId}`);
        const departments = await response.json();
        
        const select = document.getElementById('departmentSelect');
        if (select) {
            select.innerHTML = '<option value="">Select Department</option>' +
                departments.map(dept => 
                    `<option value="${dept.department_id}" ${selectedDeptId == dept.department_id ? 'selected' : ''}>
                        ${dept.name}
                    </option>`
                ).join('');
        }
    } catch (error) {
        console.error('Error loading departments:', error);
    }
}
        // Dashboard Functions (unchanged)
        async function loadDashboard() {
            try {
                const statsResponse = await fetch('/api/statistics/dashboard');
                const stats = await statsResponse.json();
                
                const dashboardHTML = `
                    <div class="stat-card" onclick="showSection('institutions')">
                        <div class="icon"><i class="fas fa-university"></i></div>
                        <div class="stat-number">${stats.total_institutions || 0}</div>
                        <div class="stat-label">Institutions</div>
                    </div>
                    <div class="stat-card" onclick="showSection('researchers')">
                        <div class="icon"><i class="fas fa-user-graduate"></i></div>
                        <div class="stat-number">${stats.total_researchers || 0}</div>
                        <div class="stat-label">Researchers</div>
                    </div>
                    <div class="stat-card" onclick="showSection('projects')">
                        <div class="icon"><i class="fas fa-project-diagram"></i></div>
                        <div class="stat-number">${stats.total_projects || 0}</div>
                        <div class="stat-label">Projects</div>
                    </div>
                    <div class="stat-card" onclick="showSection('papers')">
                        <div class="icon"><i class="fas fa-file-alt"></i></div>
                        <div class="stat-number">${stats.total_papers || 0}</div>
                        <div class="stat-label">Publications</div>
                    </div>
                    <div class="stat-card" onclick="showSection('statistics')">
                        <div class="icon"><i class="fas fa-quote-right"></i></div>
                        <div class="stat-number">${stats.total_citations || 0}</div>
                        <div class="stat-label">Citations</div>
                    </div>
                    <div class="stat-card" onclick="showSection('statistics')">
                        <div class="icon"><i class="fas fa-hand-holding-usd"></i></div>
                        <div class="stat-number">PKR ${(stats.active_funding || 0).toLocaleString()}</div>
                        <div class="stat-label">Active Funding</div>
                    </div>
                `;
                
                document.getElementById('dashboardStats').innerHTML = dashboardHTML;
                
                await loadPublicationsChart();
                await loadProjectCompletionChart();
                await loadLeaderboard();
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showNotification('Failed to load dashboard data', 'error');
            }
        }

        async function loadPublicationsChart() {
            try {
                const response = await fetch('/api/statistics/publications-per-year');
                const data = await response.json();
                
                const chartContainer = document.querySelector('#publicationsChart > div');
                chartContainer.innerHTML = '';
                
                if (data.length === 0) {
                    chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">No publication data available</div>';
                    return;
                }
                
                const maxCount = Math.max(...data.map(item => item.count));
                
                data.forEach(item => {
                    const height = (item.count / maxCount) * 100;
                    const bar = document.createElement('div');
                    bar.style.cssText = `
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        justify-content: flex-end;
                        height: 100%;
                        width: 60px;
                    `;
                    
                    bar.innerHTML = `
                        <div style="
                            width: 30px;
                            height: ${height}%;
                            background: linear-gradient(to top, #667eea, #764ba2);
                            border-radius: 5px 5px 0 0;
                            position: relative;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        "
                        onmouseenter="this.style.transform='scaleY(1.1)'"
                        onmouseleave="this.style.transform='scaleY(1)'"
                        title="${item.year}: ${item.count} publications">
                            <div style="
                                position: absolute;
                                top: -25px;
                                left: 0;
                                right: 0;
                                text-align: center;
                                font-size: 0.8rem;
                                color: var(--text-primary);
                                font-weight: 600;
                            ">${item.count}</div>
                        </div>
                        <div style="
                            margin-top: 10px;
                            font-size: 0.8rem;
                            color: var(--text-secondary);
                            font-weight: 600;
                        ">${item.year}</div>
                    `;
                    
                    chartContainer.appendChild(bar);
                });
                
            } catch (error) {
                console.error('Error loading publications chart:', error);
            }
        }

        async function loadProjectCompletionChart() {
            try {
                const response = await fetch('/api/statistics/project-completion');
                const data = await response.json();
                
                const chartContainer = document.querySelector('#completionChart > div');
                chartContainer.innerHTML = '';
                
                if (data.length === 0) {
                    chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">No project data available</div>';
                    return;
                }
                
                const total = data.reduce((sum, item) => sum + item.count, 0);
                
                let conicGradient = '';
                let currentAngle = 0;
                
                const colors = {
                    'Active': '#667eea',
                    'Completed': '#4facfe',
                    'Planning': '#f093fb',
                    'Ongoing': '#fa709a'
                };
                
                data.forEach((item, index) => {
                    const percentage = (item.count / total) * 100;
                    const angle = (percentage / 100) * 360;
                    const color = colors[item.project_status] || `hsl(${index * 90}, 70%, 60%)`;
                    
                    conicGradient += `${color} ${currentAngle}deg ${currentAngle + angle}deg, `;
                    currentAngle += angle;
                });
                
                conicGradient = conicGradient.slice(0, -2);
                
                const pieChart = document.createElement('div');
                pieChart.style.cssText = `
                    width: 150px;
                    height: 150px;
                    border-radius: 50%;
                    background: conic-gradient(${conicGradient});
                    margin: 0 auto;
                    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                `;
                chartContainer.appendChild(pieChart);
                
                const legend = document.createElement('div');
                legend.style.cssText = `
                    display: flex;
                    flex-wrap: wrap;
                    justify-content: center;
                    gap: 10px;
                    margin-top: 20px;
                `;
                
                data.forEach((item, index) => {
                    const color = colors[item.project_status] || `hsl(${index * 90}, 70%, 60%)`;
                    const percentage = ((item.count / total) * 100).toFixed(1);
                    
                    const legendItem = document.createElement('div');
                    legendItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        font-size: 0.85rem;
                        color: var(--text-secondary);
                        background: rgba(255,255,255,0.05);
                        padding: 8px 12px;
                        border-radius: 8px;
                    `;
                    legendItem.innerHTML = `
                        <div style="width: 12px; height: 12px; background: ${color}; border-radius: 2px; margin-right: 8px;"></div>
                        ${item.project_status}: ${item.count} (${percentage}%)
                    `;
                    legend.appendChild(legendItem);
                });
                
                chartContainer.appendChild(legend);
                
            } catch (error) {
                console.error('Error loading project completion chart:', error);
            }
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch('/api/statistics/top-researchers');
                const topResearchers = await response.json();
                
                const leaderboardHTML = topResearchers.map((res, index) => `
    <div class="leaderboard-item">
        <div class="rank">#${index + 1}</div>
        <div style="flex: 1;">
            <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">
                ${res.full_name}
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px;">
                ${res.current_institution || 'Unknown Institution'}
            </div>
        </div>
        <div style="text-align: right;">
            <div class="badge badge-published" style="font-size: 0.7rem; padding: 3px 8px;">
                ${res.citation_count || 0} citations
            </div>
            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 3px;">
                ${res.paper_count || 0} papers
            </div>
        </div>
    </div>
`).join('');
                
                document.getElementById('leaderboard').innerHTML = leaderboardHTML;
            } catch (error) {
                console.error('Error loading leaderboard:', error);
            }
        }

        // Institutions Functions
async function loadInstitutions() {
    try {
        const type = document.getElementById('institutionTypeFilter')?.value || '';
        const search = document.getElementById('institutionSearch')?.value || '';
        
        const queryParams = new URLSearchParams();
        if (type) queryParams.append('type', type);
        if (search) queryParams.append('search', search);
        
        const response = await fetch(`/api/institutions?${queryParams.toString()}`);
        const institutions = await response.json();
        
        const tbody = document.getElementById('institutionsBody');
        if (institutions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-university" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        No institutions found
                    </td>
                </tr>
            `;
        } else {
            tbody.innerHTML = institutions.map(inst => `
                <tr>
                    <td><strong>${inst.name}</strong></td>
                    <td>${inst.location || '-'}</td>
                    <td><span class="badge ${inst.type === 'Public University' ? 'badge-active' : 'badge-published'}">${inst.type || 'Unknown'}</span></td>
                    <td>${inst.established_date ? new Date(inst.established_date).toLocaleDateString() : '-'}</td>
                    <td>${inst.website_url ? `<a href="${inst.website_url}" target="_blank" style="color: #667eea; text-decoration: none;"><i class="fas fa-external-link-alt"></i> Visit</a>` : '-'}</td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 8px;">
                            <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;" 
                                    onclick="showDetailsModal('institution', ${inst.institution_id})">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button class="btn btn-warning" style="padding: 8px 16px; font-size: 13px;" 
                                    onclick="showEditInstitutionForm(${inst.institution_id})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="btn btn-danger" style="padding: 8px 16px; font-size: 13px;" 
                                    onclick="confirmDelete('institution', ${inst.institution_id}, '${inst.name.replace(/'/g, "\\\\'")}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }
        
        addExportButtons();
        
    } catch (error) {
        console.error('Error loading institutions:', error);
        showNotification('Failed to load institutions', 'error');
        
        const tbody = document.getElementById('institutionsBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-secondary);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; display: block;"></i>
                        Failed to load institutions. Please try again.
                    </td>
                </tr>
            `;
        }
    }
}
        function filterInstitutions() {
            loadInstitutions();
            
        }


        // Unified Details Modal Function
        async function showDetailsModal(type, id) {
            try {
                let endpoint, title;
                
                switch(type) {
                    case 'institution':
                        endpoint = `/api/institutions/${id}`;
                        title = 'Institution Details';
                        break;
                    case 'researcher':
                        endpoint = `/api/researchers/${id}`;
                        title = 'Researcher Details';
                        break;
                    case 'project':
                        endpoint = `/api/projects/${id}`;
                        title = 'Project Details';
                        break;
                    case 'paper':
                        endpoint = `/api/papers/${id}`;
                        title = 'Publication Details';
                        break;
                }
                
                const response = await fetch(endpoint);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalBody').innerHTML = renderModalContent(type, data);
                
                document.getElementById('detailsModal').classList.add('active');
                
            } catch (error) {
                console.error(`Error fetching ${type} details:`, error);
                showNotification(`Failed to load ${type} details`, 'error');
            }
        }

        function renderModalContent(type, data) {
            switch(type) {
                case 'institution':
                    return renderInstitutionModal(data);
                case 'researcher':
                    return renderResearcherModal(data);
                case 'project':
                    return renderProjectModal(data);
                case 'paper':
                    return renderPaperModal(data);
                default:
                    return '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">No data available</div>';
            }
        }

        function renderInstitutionModal(data) {
            return `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-map-marker-alt" style="color: #667eea;"></i>
                        <span>${data.location || 'Location not specified'}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-tag" style="color: #667eea;"></i>
                        <span class="badge ${data.type === 'Public University' ? 'badge-active' : 'badge-published'}">
                            ${data.type || 'Unknown Type'}
                        </span>
                    </div>
                    ${data.description ? `
                        <div style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                            <p style="color: var(--text-secondary); line-height: 1.6;">${data.description}</p>
                        </div>
                    ` : ''}
                </div>
                
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.department_count || 0}</div>
                        <div class="modal-stat-label">Departments</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.researcher_count || 0}</div>
                        <div class="modal-stat-label">Researchers</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.project_count || 0}</div>
                        <div class="modal-stat-label">Projects</div>
                    </div>
                </div>
                
                ${data.website_url ? `
                    <div style="margin-top: 1.5rem;">
                        <a href="${data.website_url}" target="_blank" 
                           class="btn btn-primary" style="width: 100%; text-align: center;">
                            <i class="fas fa-external-link-alt"></i> Visit Website
                        </a>
                    </div>
                ` : ''}
            `;
        }

        function renderResearcherModal(data) {
            return `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-envelope" style="color: #667eea;"></i>
                        <span>${data.email || 'No email provided'}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-university" style="color: #667eea;"></i>
                        <span>${data.current_institution || 'No institution'}</span>
                    </div>
                    ${data.academic_rank ? `
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <i class="fas fa-graduation-cap" style="color: #667eea;"></i>
                            <span>${data.academic_rank}</span>
                        </div>
                    ` : ''}
                </div>
                
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.publication_count || 0}</div>
                        <div class="modal-stat-label">Publications</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.citation_count || 0}</div>
                        <div class="modal-stat-label">Citations</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.project_count || 0}</div>
                        <div class="modal-stat-label">Projects</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.h_index || 'N/A'}</div>
                        <div class="modal-stat-label">H-Index</div>
                    </div>
                </div>
                
                ${data.research_areas && data.research_areas !== 'No research areas' ? `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                            <i class="fas fa-tags"></i> Research Areas
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                            ${data.research_areas.split(', ').map(area => `
                                <span style="background: rgba(102, 126, 234, 0.2); color: #667eea; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem;">
                                    ${area}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${data.orcid_id ? `
                    <div style="margin-top: 1.5rem;">
                        <a href="https://orcid.org/${data.orcid_id}" target="_blank" 
                           class="btn btn-primary" style="width: 100%; text-align: center;">
                            <i class="fab fa-orcid"></i> View ORCID Profile
                        </a>
                    </div>
                ` : ''}
            `;
        }

        function renderProjectModal(data) {
            return `
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-university" style="color: #667eea;"></i>
                        <span>${data.institution_name || 'No institution'}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-calendar-alt" style="color: #667eea;"></i>
                        <span>${new Date(data.start_date).toLocaleDateString()} - 
                              ${data.end_date ? new Date(data.end_date).toLocaleDateString() : 'Present'}</span>
                    </div>
                    <div style="margin-top: 1rem;">
                        <span class="badge ${data.project_status === 'Active' ? 'badge-active' : 
                                         data.project_status === 'Completed' ? 'badge-completed' : 'badge-published'}">
                            <i class="fas fa-${data.project_status === 'Active' ? 'play' : 'check'}"></i> 
                            ${data.project_status || 'Unknown'}
                        </span>
                    </div>
                </div>
                
                ${data.description ? `
                    <div style="margin: 1rem 0; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.4;">
                            ${data.description}
                        </div>
                    </div>
                ` : ''}
                
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.team_members?.length || 0}</div>
                        <div class="modal-stat-label">Team Members</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.outputs?.length || 0}</div>
                        <div class="modal-stat-label">Outputs</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.grants?.length || 0}</div>
                        <div class="modal-stat-label">Grants</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.funding_amount ? `PKR ${data.funding_amount.toLocaleString()}` : 'N/A'}</div>
                        <div class="modal-stat-label">Funding</div>
                    </div>
                </div>
                
                ${data.team_members && data.team_members.length > 0 ? `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                            <i class="fas fa-users"></i> Team Members
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); max-height: 150px; overflow-y: auto;">
                            ${data.team_members.map(member => 
                                `<div style="padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                    <div><strong>${member.full_name}</strong></div>
                                    <div style="font-size: 0.85rem; opacity: 0.8;">
                                        ${member.role_in_project || 'Team Member'}
                                    </div>
                                </div>`
                            ).join('')}
                        </div>
                    </div>
                ` : ''}
            `;
        }

        function renderPaperModal(data) {
            return `
                <div style="margin-bottom: 1.5rem;">
                    ${data.venue_name ? `
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <i class="fas fa-map-marker-alt" style="color: #667eea;"></i>
                            <span>${data.venue_name}${data.venue_type ? ` (${data.venue_type})` : ''}</span>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                        <i class="fas fa-calendar" style="color: #667eea;"></i>
                        <span>${data.publication_date ? new Date(data.publication_date).toLocaleDateString() : 'Date not specified'}</span>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <span class="badge ${data.manuscript_status === 'Published' ? 'badge-published' : 
                                         data.manuscript_status === 'Accepted' ? 'badge-active' : 'badge-completed'}">
                            <i class="fas fa-${data.manuscript_status === 'Published' ? 'check-circle' : 'clock'}"></i> 
                            ${data.manuscript_status || 'Unknown'}
                        </span>
                    </div>
                </div>
                
                ${data.abstract ? `
                    <div style="margin: 1rem 0; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Abstract</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                            ${data.abstract}
                        </div>
                    </div>
                ` : ''}
                
                <div class="modal-stats">
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.citation_count || 0}</div>
                        <div class="modal-stat-label">Citations</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.authors?.length || 0}</div>
                        <div class="modal-stat-label">Authors</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.keywords?.length || 0}</div>
                        <div class="modal-stat-label">Keywords</div>
                    </div>
                    <div class="modal-stat">
                        <div class="modal-stat-number">${data.page_count || 'N/A'}</div>
                        <div class="modal-stat-label">Pages</div>
                    </div>
                </div>
                
                ${data.doi ? `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                            <i class="fas fa-link"></i> DOI
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); word-break: break-all; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px;">
                            ${data.doi}
                        </div>
                    </div>
                ` : ''}
                
                ${data.authors && data.authors.length > 0 ? `
                    <div style="margin-top: 1rem;">
                        <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                            <i class="fas fa-users"></i> Authors
                        </div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary);">
                            ${data.authors.map(author => `<div style="padding: 3px 0;"> ${author}</div>`).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${data.doi ? `
                    <div style="margin-top: 1.5rem;">
                        <a href="https://doi.org/${data.doi}" target="_blank" 
                           class="btn btn-primary" style="width: 100%; text-align: center;">
                            <i class="fas fa-external-link-alt"></i> View Publication
                        </a>
                    </div>
                ` : ''}
            `;
        }

        function closeModal() {
            document.getElementById('detailsModal').classList.remove('active');
        }

        // Researchers Functions
        async function loadResearchers() {
            try {
                const response = await fetch('/api/researchers');
                const researchers = await response.json();
                
                const grid = document.getElementById('researchersGrid');
                if (researchers.length === 0) {
                    grid.innerHTML = `
                        <div class="item-card" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-user-graduate" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                            <div style="color: var(--text-secondary);">No researchers found</div>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = researchers.map(res => `
    <div class="item-card">
        <div class="card-title">${res.full_name}</div>
        <div class="card-subtitle">
            <i class="fas fa-envelope"></i> ${res.email || 'No email'}
        </div>
        <div class="card-meta">
            <span class="badge badge-active">
                <i class="fas fa-graduation-cap"></i> ${res.academic_rank || 'Not specified'}
            </span>
            <span><i class="fas fa-university"></i> ${res.institution_name || 'Unknown'}</span>
        </div>
        <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
            <i class="fas fa-id-card"></i> ${res.orcid_id || 'No ORCID'}
        </div>
        <div style="display: flex; gap: 8px; margin-top: 1rem; flex-wrap: wrap;">
    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
            onclick="showDetailsModal('researcher', ${res.researcher_id})">
        <i class="fas fa-eye"></i> View
    </button>
    <button class="btn btn-warning" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
            onclick="showEditResearcherForm(${res.researcher_id})">
        <i class="fas fa-edit"></i> Edit
    </button>
    <button class="btn btn-danger" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
            onclick="confirmDelete('researcher', ${res.researcher_id}, '${res.full_name.replace(/'/g, "\\'")}')">
        <i class="fas fa-trash"></i> Delete
    </button>
</div>
    </div>
`).join('');
                addExportButtons();
            } catch (error) {
                console.error('Error loading researchers:', error);
                showNotification('Failed to load researchers', 'error');
            }
            
        }

        // Projects Functions
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const projects = await response.json();
                
                const grid = document.getElementById('projectsGrid');
                if (projects.length === 0) {
                    grid.innerHTML = `
                        <div class="item-card" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-project-diagram" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                            <div style="color: var(--text-secondary);">No projects found</div>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = projects.map(proj => `
    <div class="item-card" style="padding: 1.2rem;">
    <div class="card-title" style="margin-bottom: 0.4rem; font-size: 1.1rem;">${proj.project_title}</div>
    <div class="card-subtitle" style="margin-bottom: 0.4rem; font-size: 0.85rem;">
        <i class="fas fa-university"></i> ${proj.institution_name || 'Unknown'}
    </div>
    <div class="card-meta" style="gap: 0.4rem; margin-bottom: 0.6rem; font-size: 0.8rem;">
        <span class="badge ${proj.project_status === 'Active' ? 'badge-active' : proj.project_status === 'Completed' ? 'badge-completed' : 'badge-published'}" style="padding: 3px 8px; font-size: 0.7rem;">
            <i class="fas fa-${proj.project_status === 'Active' ? 'play' : 'check'}"></i> ${proj.project_status}
        </span>
        <span title="Team members"><i class="fas fa-users"></i> ${proj.team_size || 0}</span>
        <span title="Outputs"><i class="fas fa-file"></i> ${proj.outputs_count || 0}</span>
    </div>
    <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.2; margin-bottom: 0.6rem;">
        ${proj.description ? proj.description.substring(0, 100) + '...' : 'No description'}
    </div>
    ${proj.team_members ? `
        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.6rem;">
            <i class="fas fa-user-friends"></i> ${proj.team_members.substring(0, 40)}${proj.team_members.length > 40 ? '...' : ''}
        </div>
    ` : ''}
    <div style="display: flex; gap: 4px; margin-top: 0.6rem;">
        <button class="btn btn-secondary" style="padding: 4px 8px; font-size: 11px; flex: 1;" 
                onclick="showDetailsModal('project', ${proj.project_id})">
            <i class="fas fa-eye"></i> View
        </button>
        <button class="btn btn-warning" style="padding: 4px 8px; font-size: 11px; flex: 1;" 
                onclick="showEditProjectForm(${proj.project_id})">
            <i class="fas fa-edit"></i> Edit
        </button>
        <button class="btn btn-danger" style="padding: 4px 8px; font-size: 11px; flex: 1;" 
                onclick="confirmDelete('project', ${proj.project_id}, '${proj.project_title.replace(/'/g, "\\'")}')">
            <i class="fas fa-trash"></i> Delete
        </button>
    </div>
</div>
    </div>
`).join('');
               addExportButtons(); 
            } catch (error) {
                console.error('Error loading projects:', error);
                showNotification('Failed to load projects', 'error');
            }
            
        }

        // Papers Functions
        async function loadPapers() {
            try {
                const response = await fetch('/api/papers');
                const papers = await response.json();
                
                const grid = document.getElementById('papersGrid');
                if (papers.length === 0) {
                    grid.innerHTML = `
                        <div class="item-card" style="text-align: center; padding: 3rem;">
                            <i class="fas fa-file-alt" style="font-size: 3rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                            <div style="color: var(--text-secondary);">No publications found</div>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = papers.map(paper => `
    <div class="item-card">
        <div class="card-title">${paper.title}</div>
        <div class="card-subtitle">
            <i class="fas fa-map-marker-alt"></i> ${paper.venue_name || 'No venue specified'}
        </div>
        <div class="card-meta">
            <span class="badge badge-published">
                <i class="fas fa-book"></i> ${paper.manuscript_status || 'Unknown'}
            </span>
            <span><i class="fas fa-calendar"></i> ${paper.publication_date ? new Date(paper.publication_date).toLocaleDateString() : 'N/A'}</span>
            <span><i class="fas fa-chart-line"></i> ${paper.citation_count || 0} citations</span>
        </div>
        <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">
            ${paper.abstract ? paper.abstract.substring(0, 150) + '...' : 'No abstract'}
        </div>
        ${paper.doi ? `
            <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                <i class="fas fa-link"></i> DOI: ${paper.doi}
            </div>
        ` : ''}
        ${paper.authors ? `
            <div style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-secondary);">
                <i class="fas fa-users"></i> Authors: ${paper.authors}
            </div>
        ` : ''}
<div style="display: flex; gap: 8px; margin-top: 1rem; flex-wrap: wrap;">
    <button class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
            onclick="showDetailsModal('paper', ${paper.output_id})">
        <i class="fas fa-eye"></i> View
    </button>
    <button class="btn btn-warning" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
            onclick="showEditPaperForm(${paper.output_id})">
        <i class="fas fa-edit"></i> Edit
    </button>
    <button class="btn btn-danger" style="padding: 8px 16px; font-size: 13px; flex: 1;" 
            onclick="confirmDelete('paper', ${paper.output_id}, '${paper.title.substring(0, 50).replace(/'/g, "\\'")}...')">
        <i class="fas fa-trash"></i> Delete
    </button>
</div>
    </div>
`).join('');
               addExportButtons(); 
            } catch (error) {
                console.error('Error loading papers:', error);
                showNotification('Failed to load publications', 'error');
            }
            
        }

        // Statistics Functions (unchanged)
        async function loadStatistics() {
            try {
                await loadTimelineChart();
                await loadActivityChart();
            } catch (error) {
                console.error('Error loading statistics:', error);
                showNotification('Failed to load analytics', 'error');
            }
        }

        async function loadTimelineChart() {
            try {
                const response = await fetch('/api/statistics/publications-per-year');
                const data = await response.json();
                
                const chartContainer = document.getElementById('timelineChart');
                chartContainer.innerHTML = '';
                
                if (data.length === 0) {
                    chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">No timeline data available</div>';
                    return;
                }
                
                const timeline = document.createElement('div');
                timeline.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    height: 100%;
                    overflow-y: auto;
                    padding-right: 10px;
                `;
                
                data.forEach(item => {
                    const timelineItem = document.createElement('div');
                    timelineItem.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        padding: 12px;
                        background: rgba(255,255,255,0.05);
                        border-radius: 8px;
                        border-left: 4px solid #667eea;
                    `;
                    
                    timelineItem.innerHTML = `
                        <div style="
                            width: 60px;
                            text-align: center;
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            padding: 8px;
                            border-radius: 6px;
                            font-weight: 600;
                        ">${item.year}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">Publications</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${item.count} papers published</div>
                        </div>
                        <div style="
                            background: rgba(102, 126, 234, 0.1);
                            color: #667eea;
                            padding: 6px 12px;
                            border-radius: 20px;
                            font-size: 0.85rem;
                            font-weight: 600;
                        ">${item.count}</div>
                    `;
                    
                    timeline.appendChild(timelineItem);
                });
                
                chartContainer.appendChild(timeline);
                
            } catch (error) {
                console.error('Error loading timeline chart:', error);
            }
        }

        async function loadActivityChart() {
            try {
                const response = await fetch('/api/statistics/project-completion');
                const data = await response.json();
                
                const chartContainer = document.getElementById('activityChart');
                chartContainer.innerHTML = '';
                
                if (data.length === 0) {
                    chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">No activity data available</div>';
                    return;
                }
                
                const activityBars = document.createElement('div');
                activityBars.style.cssText = `
                    display: flex;
                    flex-direction: column;
                    gap: 15px;
                    height: 100%;
                `;
                
                const maxCount = Math.max(...data.map(item => item.count));
                
                data.forEach(item => {
                    const width = (item.count / maxCount) * 100;
                    const activityBar = document.createElement('div');
                    activityBar.style.cssText = `
                        display: flex;
                        align-items: center;
                        gap: 15px;
                    `;
                    
                    activityBar.innerHTML = `
                        <div style="
                            width: 120px;
                            font-size: 0.9rem;
                            color: var(--text-primary);
                            font-weight: 600;
                        ">${item.project_status}</div>
                        <div style="flex: 1;">
                            <div style="
                                width: ${width}%;
                                height: 25px;
                                background: linear-gradient(90deg, #667eea, #764ba2);
                                border-radius: 5px;
                                transition: width 1s ease;
                                position: relative;
                            ">
                                <div style="
                                    position: absolute;
                                    right: -40px;
                                    top: 50%;
                                    transform: translateY(-50%);
                                    color: var(--text-primary);
                                    font-weight: 600;
                                    font-size: 0.9rem;
                                ">${item.count}</div>
                            </div>
                        </div>
                    `;
                    
                    activityBars.appendChild(activityBar);
                });
                
                chartContainer.appendChild(activityBars);
                
            } catch (error) {
                console.error('Error loading activity chart:', error);
            }
        }

        // Layout Functions

        function setupLayoutControls() {
    // Set initial view mode
    if (!currentViewMode) {
        currentViewMode = 'grid';
    }
    
    // Set the active button
    document.querySelectorAll('.layout-btn').forEach((btn, index) => {
        if (index === 0) btn.classList.add('active');
    });
}
// Custom Cursor Setup

// Inside the click event listener in setupCustomCursor():
document.addEventListener('click', (e) => {
    // Cursor bounce effect
    if (cursor) {
        cursor.style.transform = 'scale(0.8)';
        setTimeout(() => {
            cursor.style.transform = 'scale(1)';
        }, 100);
    }
    
    // Follower pulse effect
    if (follower) {
        follower.style.transform = 'scale(1.3)';
        follower.style.opacity = '0.7';
        setTimeout(() => {
            follower.style.transform = 'scale(1)';
            follower.style.opacity = '1';
        }, 200);
    }
    
    // Enhanced particle burst
    createParticleBurst(e.clientX, e.clientY, 20);
    
    // Additional ripple effect
    createRippleEffect(e.clientX, e.clientY);
});
function setGridView() {
    currentViewMode = 'grid';
    const cardGrids = document.querySelectorAll('.card-grid');
    
    cardGrids.forEach(grid => {
        grid.classList.remove('list-view', 'compact-view');
        grid.classList.add('grid-view');
    });
    
    // Update button states
    document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.layout-btn:nth-child(1)').classList.add('active');
    
    showNotification('Grid view activated', 'info');
}

function setListView() {
    currentViewMode = 'list';
    const cardGrids = document.querySelectorAll('.card-grid');
    
    cardGrids.forEach(grid => {
        grid.classList.remove('grid-view', 'compact-view');
        grid.classList.add('list-view');
    });
    
    // Update button states
    document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.layout-btn:nth-child(2)').classList.add('active');
    
    showNotification('List view activated', 'info');
}

function setCompactView() {
    currentViewMode = 'compact';
    const cardGrids = document.querySelectorAll('.card-grid');
    
    cardGrids.forEach(grid => {
        grid.classList.remove('grid-view', 'list-view');
        grid.classList.add('compact-view');
    });
    
    // Update button states
    document.querySelectorAll('.layout-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelector('.layout-btn:nth-child(3)').classList.add('active');
    
    showNotification('Compact view activated', 'info');
}

function resetLayout() {
    // Reset filters
    document.getElementById('institutionTypeFilter').value = '';
    document.getElementById('institutionSearch').value = '';
    
    // Reset to grid view
    setGridView();
    
    // Reload current section data
    if (currentSection) {
        loadSectionData(currentSection);
    }
    
    showNotification('Layout reset successfully', 'success');
}

        // Refresh Functions (unchanged)
        function refreshInstitutions() {
    const btn = event.target.closest('.btn');
    // Add particle burst effect
    const rect = btn.getBoundingClientRect();
    createParticleBurst(
        rect.left + rect.width/2,
        rect.top + rect.height/2,
        15
    );
    
    loadInstitutions();
    showNotification('Institutions refreshed', 'success');
}

        function refreshResearchers() {
    const btn = event.target.closest('.btn');
    const rect = btn.getBoundingClientRect();
    createParticleBurst(
        rect.left + rect.width/2,
        rect.top + rect.height/2,
        15
    );
    
    loadResearchers();
    showNotification('Researchers refreshed', 'success');
}

        function refreshProjects() {
            loadProjects();
            showNotification('Projects refreshed', 'success');
        }

        function refreshPapers() {
            loadPapers();
            showNotification('Publications refreshed', 'success');
        }

        function refreshAnalytics() {
            loadStatistics();
            showNotification('Analytics refreshed', 'success');
        }

        // Utility Functions
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationsContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = {
                success: 'fas fa-check-circle',
                error: 'fas fa-exclamation-circle',
                info: 'fas fa-info-circle',
                warning: 'fas fa-exclamation-triangle'
            }[type];
            
            notification.innerHTML = `
                <i class="${icon}" style="color: ${type === 'success' ? '#2ed573' : type === 'error' ? '#f5576c' : '#667eea'}"></i>
                <div>${message}</div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 10);
            
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }
// ==================== CRUD ENDPOINTS ====================

// Add new institution
app.post('/api/institutions', async (req, res) => {
    try {
        const { name, location, type, established_date, website_url, description } = req.body;
        
        const [result] = await promisePool.execute(
            `INSERT INTO INSTITUTION (name, location, type, established_date, website_url, description) 
             VALUES (?, ?, ?, ?, ?, ?)`,
            [name, location, type, established_date || null, website_url || null, description || null]
        );
        
        res.status(201).json({ 
            success: true, 
            institution_id: result.insertId,
            message: 'Institution created successfully' 
        });
    } catch (error) {
        console.error('Error creating institution:', error);
        res.status(500).json({ error: 'Server error' });
    }
});

// Update institution
app.put('/api/institutions/:id', async (req, res) => {
    try {
        const { name, location, type, established_date, website_url, description } = req.body;
        
        const [result] = await promisePool.execute(
            `UPDATE INSTITUTION 
             SET name = ?, location = ?, type = ?, established_date = ?, 
                 website_url = ?, description = ?
             WHERE institution_id = ?`,
            [name, location, type, established_date || null, website_url || null, 
             description || null, req.params.id]
        );
        
        if (result.affectedRows === 0) {
            return res.status(404).json({ error: 'Institution not found' });
        }
        
        res.json({ success: true, message: 'Institution updated successfully' });
    } catch (error) {
        console.error('Error updating institution:', error);
        res.status(500).json({ error: 'Server error' });
    }
});

// Update institution delete endpoint
app.delete('/api/institutions/:id', async (req, res) => {
    let connection;
    
    try {
        connection = await promisePool.getConnection();
        await connection.beginTransaction();
        
        // Check if institution exists
        const [existing] = await connection.execute(
            'SELECT institution_id FROM INSTITUTION WHERE institution_id = ?',
            [req.params.id]
        );
        
        if (existing.length === 0) {
            await connection.rollback();
            return res.status(404).json({ error: 'Institution not found' });
        }
        
        // Check for dependencies
        const [departments] = await connection.execute(
            'SELECT department_id FROM DEPARTMENT WHERE institution_id = ?',
            [req.params.id]
        );
        
        // Delete each department's dependencies
        for (const dept of departments) {
            // Delete projects in this department
            await connection.execute(
                'DELETE FROM RESEARCH_PROJECT WHERE department_id = ?',
                [dept.department_id]
            );
            
            // Delete employment records for this department
            await connection.execute(
                'DELETE FROM EMPLOYMENT WHERE department_id = ?',
                [dept.department_id]
            );
            
            // Delete the department
            await connection.execute(
                'DELETE FROM DEPARTMENT WHERE department_id = ?',
                [dept.department_id]
            );
        }
        
        // Delete institution
        await connection.execute(
            'DELETE FROM INSTITUTION WHERE institution_id = ?',
            [req.params.id]
        );
        
        await connection.commit();
        
        res.json({ 
            success: true, 
            message: `Institution deleted successfully${departments.length > 0 ? ' (and all associated departments)' : ''}` 
        });
        
    } catch (error) {
        if (connection) await connection.rollback();
        console.error('Error deleting institution:', error);
        res.status(500).json({ error: 'Server error: ' + error.message });
    } finally {
        if (connection) connection.release();
    }
});
// Add new researcher with employment and research areas
app.post('/api/researchers', async (req, res) => {
    const connection = await promisePool.getConnection();
    
    try {
        await connection.beginTransaction();
        
        const { full_name, email, academic_rank, orcid_id, google_scholar_id, 
                institution_id, research_areas } = req.body;
        
        // Insert researcher
        const [researcherResult] = await connection.execute(
            `INSERT INTO RESEARCHER (full_name, email, academic_rank, orcid_id, google_scholar_id) 
             VALUES (?, ?, ?, ?, ?)`,
            [full_name, email, academic_rank || null, orcid_id || null, google_scholar_id || null]
        );
        
        const researcherId = researcherResult.insertId;
        
        // Create employment if institution provided
        if (institution_id) {
            // First get a department from the institution
            const [departments] = await connection.execute(
                `SELECT department_id FROM DEPARTMENT WHERE institution_id = ? LIMIT 1`,
                [institution_id]
            );
            
            if (departments.length > 0) {
                await connection.execute(
                    `INSERT INTO EMPLOYMENT (researcher_id, department_id, start_date, employment_type) 
                     VALUES (?, ?, CURDATE(), 'Full-time')`,
                    [researcherId, departments[0].department_id]
                );
            }
        }
        
        // Add research areas if provided
        if (research_areas && research_areas.trim()) {
            const areas = research_areas.split(',').map(area => area.trim());
            
            for (const area of areas) {
                if (area) {
                    // Check if area exists
                    const [existingArea] = await connection.execute(
                        `SELECT research_area_id FROM RESEARCH_AREA WHERE area_name = ?`,
                        [area]
                    );
                    
                    let areaId;
                    if (existingArea.length > 0) {
                        areaId = existingArea[0].research_area_id;
                    } else {
                        const [areaResult] = await connection.execute(
                            `INSERT INTO RESEARCH_AREA (area_name) VALUES (?)`,
                            [area]
                        );
                        areaId = areaResult.insertId;
                    }
                    
                    // Link researcher to research area
                    await connection.execute(
                        `INSERT INTO RESEARCH_AREA_MAPPING (researcher_id, research_area_id) 
                         VALUES (?, ?)`,
                        [researcherId, areaId]
                    );
                }
            }
        }
        
        await connection.commit();
        
        res.status(201).json({ 
            success: true, 
            researcher_id: researcherId,
            message: 'Researcher created successfully' 
        });
        
    } catch (error) {
        await connection.rollback();
        console.error('Error creating researcher:', error);
        res.status(500).json({ error: 'Server error' });
    } finally {
        connection.release();
    }
});

// Add new project with team members
app.post('/api/projects', async (req, res) => {
    const connection = await promisePool.getConnection();
    
    try {
        await connection.beginTransaction();
        
        const { project_title, description, start_date, end_date, 
                project_status, department_id, team_members } = req.body;
        
        // Insert project
        const [projectResult] = await connection.execute(
            `INSERT INTO RESEARCH_PROJECT 
             (project_title, description, start_date, end_date, project_status, department_id) 
             VALUES (?, ?, ?, ?, ?, ?)`,
            [project_title, description || null, start_date, end_date || null, 
             project_status, department_id || null]
        );
        
        const projectId = projectResult.insertId;
        
        // Add team members if provided
        if (team_members && Array.isArray(team_members)) {
            for (const memberId of team_members) {
                await connection.execute(
                    `INSERT INTO PROJECT_MEMBER (project_id, researcher_id, role_in_project) 
                     VALUES (?, ?, 'Team Member')`,
                    [projectId, memberId]
                );
            }
        }
        
        await connection.commit();
        
        res.status(201).json({ 
            success: true, 
            project_id: projectId,
            message: 'Project created successfully' 
        });
        
    } catch (error) {
        await connection.rollback();
        console.error('Error creating project:', error);
        res.status(500).json({ error: 'Server error' });
    } finally {
        connection.release();
    }
});

// Add new paper with authors
app.post('/api/papers', async (req, res) => {
    const connection = await promisePool.getConnection();
    
    try {
        await connection.beginTransaction();
        
        const { title, abstract, publication_date, manuscript_status, 
                doi, venue_id, authors, keywords } = req.body;
        
        // First create research output
        const [outputResult] = await connection.execute(
            `INSERT INTO RESEARCH_OUTPUT (title, description, visibility_status) 
             VALUES (?, ?, 'Public')`,
            [title, abstract || null]
        );
        
        const outputId = outputResult.insertId;
        
        // Then create paper
        await connection.execute(
            `INSERT INTO PAPER (paper_id, abstract, publication_date, manuscript_status, doi, venue_id) 
             VALUES (?, ?, ?, ?, ?, ?)`,
            [outputId, abstract || null, publication_date || null, 
             manuscript_status || 'Published', doi || null, venue_id || null]
        );
        
        // Add authors
        if (authors && Array.isArray(authors)) {
            for (let i = 0; i < authors.length; i++) {
                await connection.execute(
                    `INSERT INTO COLLABORATION (researcher_id, paper_id, author_order) 
                     VALUES (?, ?, ?)`,
                    [authors[i], outputId, i + 1]
                );
            }
        }
        
        // Add keywords
        if (keywords && keywords.trim()) {
            const keywordList = keywords.split(',').map(k => k.trim());
            
            for (const keyword of keywordList) {
                if (keyword) {
                    // Check if keyword exists
                    const [existingKeyword] = await connection.execute(
                        `SELECT keyword_id FROM KEYWORD WHERE keyword_text = ?`,
                        [keyword]
                    );
                    
                    let keywordId;
                    if (existingKeyword.length > 0) {
                        keywordId = existingKeyword[0].keyword_id;
                    } else {
                        const [keywordResult] = await connection.execute(
                            `INSERT INTO KEYWORD (keyword_text) VALUES (?)`,
                            [keyword]
                        );
                        keywordId = keywordResult.insertId;
                    }
                    
                    // Link paper to keyword
                    await connection.execute(
                        `INSERT INTO PAPER_KEYWORD (paper_id, keyword_id) 
                         VALUES (?, ?)`,
                        [outputId, keywordId]
                    );
                }
            }
        }
        
        await connection.commit();
        
        res.status(201).json({ 
            success: true, 
            output_id: outputId,
            message: 'Paper created successfully' 
        });
        
    } catch (error) {
        await connection.rollback();
        console.error('Error creating paper:', error);
        res.status(500).json({ error: 'Server error' });
    } finally {
        connection.release();
    }
});

// Add new citation
app.post('/api/citations', async (req, res) => {
    try {
        const { citing_paper_id, cited_paper_id, citation_date, 
                citation_context, citation_type, citation_notes } = req.body;
        
        const [result] = await promisePool.execute(
            `INSERT INTO CITATION 
             (citing_output_id, cited_output_id, citation_date, citation_context, citation_type, citation_notes) 
             VALUES (?, ?, ?, ?, ?, ?)`,
            [citing_paper_id, cited_paper_id, citation_date || null, 
             citation_context || null, citation_type || 'Direct', citation_notes || null]
        );
        
        res.status(201).json({ 
            success: true, 
            citation_id: result.insertId,
            message: 'Citation added successfully' 
        });
    } catch (error) {
        console.error('Error creating citation:', error);
        res.status(500).json({ error: 'Server error' });
    }
});

// Add new grant with project allocations
app.post('/api/grants', async (req, res) => {
    const connection = await promisePool.getConnection();
    
    try {
        await connection.beginTransaction();
        
        const { grant_title, funding_agency, grant_number, start_date, 
                end_date, total_amount, description, grant_status, 
                project_ids, allocation_amount } = req.body;
        
        // In the grant endpoint, modify the INSERT statement:
const [grantResult] = await connection.execute(
    `INSERT INTO \`GRANT\` 
     (grant_title, funding_agency, grant_number, start_date, end_date, 
      grant_amount, grant_status) 
     VALUES (?, ?, ?, ?, ?, ?, ?)`,
    [
        grant_title, 
        funding_agency, 
        grant_number || null,  // Send NULL if empty
        start_date, 
        end_date || null, 
        total_amount || 0, 
        grant_status || 'Active'
    ]
);
        
        const grantId = grantResult.insertId;
        
        // Add project allocations if provided
        if (project_ids && Array.isArray(project_ids)) {
            const perProjectAllocation = allocation_amount || (total_amount / project_ids.length);
            
            for (const projectId of project_ids) {
                await connection.execute(
                    `INSERT INTO PROJECT_GRANT (project_id, grant_id, allocation_amount) 
                     VALUES (?, ?, ?)`,
                    [projectId, grantId, perProjectAllocation]
                );
            }
        }
        
        await connection.commit();
        
        res.status(201).json({ 
            success: true, 
            grant_id: grantId,
            message: 'Grant added successfully' 
        });
        
    } catch (error) {
        await connection.rollback();
        console.error('Error creating grant:', error);
        res.status(500).json({ error: 'Server error' });
    } finally {
        connection.release();
    }
});

// Get departments by institution
app.get('/api/departments', async (req, res) => {
    try {
        const { institution_id } = req.query;
        
        let query = 'SELECT * FROM DEPARTMENT';
        const params = [];
        
        if (institution_id) {
            query += ' WHERE institution_id = ?';
            params.push(institution_id);
        }
        
        const [rows] = await promisePool.execute(query, params);
        res.json(rows);
    } catch (error) {
        console.error('Error fetching departments:', error);
        res.status(500).json({ error: 'Server error' });
    }
});

// Get publication venues
app.get('/api/venues', async (req, res) => {
    try {
        const [rows] = await promisePool.execute(
            'SELECT * FROM PUBLICATION_VENUE ORDER BY name'
        );
        res.json(rows);
    } catch (error) {
        console.error('Error fetching venues:', error);
        res.status(500).json({ error: 'Server error' });
    }
});

// Add new publication venue
app.post('/api/venues', async (req, res) => {
    try {
        const { name, venue_type, publisher } = req.body;
        
        const [result] = await promisePool.execute(
            `INSERT INTO PUBLICATION_VENUE (name, venue_type, publisher) 
             VALUES (?, ?, ?)`,
            [name, venue_type || 'Journal', publisher || null]
        );
        
        res.status(201).json({ 
            success: true, 
            venue_id: result.insertId,
            message: 'Venue added successfully' 
        });
    } catch (error) {
        console.error('Error creating venue:', error);
        res.status(500).json({ error: 'Server error' });
    }
});
// ==================== EDIT FUNCTIONS ====================

async function showEditResearcherForm(id) {
    try {
        const response = await fetch(`/api/researchers/${id}`);
        const researcher = await response.json();
        
        const institutions = await getInstitutions();
        
        currentEditId = id;
        currentEditType = 'researcher';
        
        // In showEditResearcherForm() function, update the form HTML:
const formHTML = `
    <form id="researcherForm" onsubmit="saveResearcher(event)">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Full Name *</label>
                <input type="text" class="form-input" name="full_name" 
                       value="${researcher.full_name || ''}" required>
            </div>
            <div class="form-group">
                <label class="form-label">Email *</label>
                <input type="email" class="form-input" name="email" 
                       value="${researcher.email || ''}" required>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Academic Rank</label>
                <select class="form-select" name="academic_rank">
                    <option value="">Select Rank</option>
                    <option value="Professor" ${researcher.academic_rank === 'Professor' ? 'selected' : ''}>Professor</option>
                    <option value="Associate Professor" ${researcher.academic_rank === 'Associate Professor' ? 'selected' : ''}>Associate Professor</option>
                    <option value="Assistant Professor" ${researcher.academic_rank === 'Assistant Professor' ? 'selected' : ''}>Assistant Professor</option>
                    <option value="Lecturer" ${researcher.academic_rank === 'Lecturer' ? 'selected' : ''}>Lecturer</option>
                    <option value="Postdoctoral Researcher" ${researcher.academic_rank === 'Postdoctoral Researcher' ? 'selected' : ''}>Postdoctoral Researcher</option>
                    <option value="PhD Student" ${researcher.academic_rank === 'PhD Student' ? 'selected' : ''}>PhD Student</option>
                    <option value="Research Assistant" ${researcher.academic_rank === 'Research Assistant' ? 'selected' : ''}>Research Assistant</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Institution</label>
                <select class="form-select" name="institution_id">
                    <option value="">Select Institution</option>
                    ${institutions.map(inst => 
                        `<option value="${inst.institution_id}" ${researcher.current_institution === inst.name ? 'selected' : ''}>
                            ${inst.name}
                        </option>`
                    ).join('')}
                </select>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">ORCID ID</label>
                <input type="text" class="form-input" name="orcid_id" 
                       value="${researcher.orcid_id || ''}" placeholder="0000-0000-0000-0000">
            </div>
            <div class="form-group">
                <label class="form-label">Profile/Google Scholar URL</label>
                <input type="text" class="form-input" name="google_scholar_id" 
                       value="${researcher.profile_url || ''}" placeholder="https://...">
            </div>
        </div>
        
        <div class="form-group">
            <label class="form-label">Research Areas (comma-separated)</label>
            <input type="text" class="form-input" name="research_areas" 
                   value="${researcher.research_areas || ''}" placeholder="Machine Learning, AI, Data Science">
        </div>
        
        <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Researcher</button>
        </div>
    </form>
`;
        document.getElementById('crudModalTitle').textContent = 'Edit Researcher';
        document.getElementById('crudFormContainer').innerHTML = formHTML;
        document.getElementById('crudModal').classList.add('active');
        
    } catch (error) {
        console.error('Error loading researcher for edit:', error);
        showNotification('Failed to load researcher data', 'error');
    }
}

async function showEditProjectForm(id) {
    try {
        const response = await fetch(`/api/projects/${id}`);
        const project = await response.json();
        
        const [institutions, researchers] = await Promise.all([
            getInstitutions(),
            getResearchers()
        ]);
        
        // Get all departments for selection
        let allDepartments = [];
        if (project.institution_id) {
            const deptResponse = await fetch(`/api/departments?institution_id=${project.institution_id}`);
            allDepartments = await deptResponse.json();
        }
        
        currentEditId = id;
        currentEditType = 'project';
        
        const formHTML = `
            <form id="projectForm" onsubmit="saveProject(event)">
                <div class="form-group">
                    <label class="form-label">Project Title *</label>
                    <input type="text" class="form-input" name="project_title" 
                           value="${project.project_title || ''}" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Institution</label>
                        <select class="form-select" name="institution_id" 
                                onchange="loadDepartmentsForProject(this.value, '${project.department_id || ''}')">
                            <option value="">Select Institution</option>
                            ${institutions.map(inst => 
                                `<option value="${inst.institution_id}" ${project.institution_name === inst.name ? 'selected' : ''}>
                                    ${inst.name}
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Department *</label>
                        <select class="form-select" name="department_id" id="departmentSelect" required>
                            <option value="">Select Department *</option>
                            ${allDepartments.map(dept => 
                                `<option value="${dept.department_id}" ${project.department_id == dept.department_id ? 'selected' : ''}>
                                    ${dept.name}
                                </option>`
                            ).join('')}
                        </select>
                        <small style="color: #f5576c; font-size: 12px;">Department is required</small>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Date *</label>
                        <input type="date" class="form-input" name="start_date" 
                               value="${project.start_date ? project.start_date.split('T')[0] : ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Date</label>
                        <input type="date" class="form-input" name="end_date" 
                               value="${project.end_date ? project.end_date.split('T')[0] : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select class="form-select" name="project_status" required>
                            <option value="Planning" ${project.project_status === 'Planning' ? 'selected' : ''}>Planning</option>
                            <option value="Active" ${project.project_status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Completed" ${project.project_status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="On Hold" ${project.project_status === 'On Hold' ? 'selected' : ''}>On Hold</option>
                            <option value="Cancelled" ${project.project_status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Team Members</label>
                    <select class="form-select" name="team_members" id="teamMembersSelect" multiple style="height: 150px;">
                        ${researchers.map(res => {
                            const isSelected = project.team_members && 
                                project.team_members.some(member => member.researcher_id == res.researcher_id);
                            return `<option value="${res.researcher_id}" ${isSelected ? 'selected' : ''}>
                                        ${res.full_name} (${res.email})
                                    </option>`;
                        }).join('')}
                    </select>
                    <small style="font-size: 12px; color: var(--text-secondary);">Hold Ctrl/Cmd to select multiple members</small>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" name="description" rows="4">${project.description || ''}</textarea>
                </div>
                
                <!-- FORM ACTIONS -->
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
                    <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Project</button>
                </div>
            </form>
        `;
        
        document.getElementById('crudModalTitle').textContent = 'Edit Project';
        document.getElementById('crudFormContainer').innerHTML = formHTML;
        document.getElementById('crudModal').classList.add('active');
        
        // Load departments if institution is already selected
        if (project.institution_id) {
            loadDepartmentsForProject(project.institution_id, project.department_id || '');
        }
        
    } catch (error) {
        console.error('Error loading project for edit:', error);
        showNotification('Failed to load project data', 'error');
    }
}

// New helper function for loading departments in project form
async function loadDepartmentsForProject(institutionId, selectedDeptId = '') {
    if (!institutionId) return;
    
    try {
        const response = await fetch(`/api/departments?institution_id=${institutionId}`);
        const departments = await response.json();
        
        const select = document.getElementById('departmentSelect');
        if (select) {
            select.innerHTML = '<option value="">Select Department *</option>' +
                departments.map(dept => 
                    `<option value="${dept.department_id}" ${selectedDeptId == dept.department_id ? 'selected' : ''}>
                        ${dept.name}
                    </option>`
                ).join('');
        }
    } catch (error) {
        console.error('Error loading departments:', error);
    }
}
async function showEditPaperForm(id) {
    try {
        const response = await fetch(`/api/papers/${id}`);
        const paper = await response.json();
        
        const [researchers, venues] = await Promise.all([
            getResearchers(),
            getPublicationVenues()
        ]);
        
        currentEditId = id;
        currentEditType = 'paper';
        
        const formHTML = `
            <form id="paperForm" onsubmit="savePaper(event)">
                <div class="form-group">
                    <label class="form-label">Title *</label>
                    <input type="text" class="form-input" name="title" 
                           value="${paper.title || ''}" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Authors *</label>
                        <select class="form-select" name="authors" id="authorsSelect" multiple required style="height: 150px;">
                            ${researchers.map(res => {
                                const isSelected = paper.authors && 
                                    paper.authors.some(author => author.researcher_id == res.researcher_id);
                                return `<option value="${res.researcher_id}" ${isSelected ? 'selected' : ''}>
                                            ${res.full_name} (${res.email})
                                        </option>`;
                            }).join('')}
                        </select>
                        <small class="form-error">Hold Ctrl/Cmd to select multiple authors</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Publication Venue</label>
                        <select class="form-select" name="venue_id">
                            <option value="">Select Venue</option>
                            ${venues.map(venue => 
                                `<option value="${venue.venue_id}" ${paper.venue_id == venue.venue_id ? 'selected' : ''}>
                                    ${venue.name} (${venue.venue_type})
                                </option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Publication Date</label>
                        <input type="date" class="form-input" name="publication_date" 
                               value="${paper.publication_date ? paper.publication_date.split('T')[0] : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="manuscript_status">
                            <option value="Submitted" ${paper.manuscript_status === 'Submitted' ? 'selected' : ''}>Submitted</option>
                            <option value="Under Review" ${paper.manuscript_status === 'Under Review' ? 'selected' : ''}>Under Review</option>
                            <option value="Accepted" ${paper.manuscript_status === 'Accepted' ? 'selected' : ''}>Accepted</option>
                            <option value="Published" ${paper.manuscript_status === 'Published' ? 'selected' : ''}>Published</option>
                            <option value="Rejected" ${paper.manuscript_status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">DOI</label>
                        <input type="text" class="form-input" name="doi" 
                               value="${paper.doi || ''}" placeholder="10.xxxx/xxxx">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Abstract</label>
                    <textarea class="form-textarea" name="abstract" rows="6">${paper.abstract || ''}</textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Keywords (comma-separated)</label>
                    <input type="text" class="form-input" name="keywords" 
                           value="${paper.keywords ? paper.keywords.join(', ') : ''}" 
                           placeholder="machine learning, ai, deep learning">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Publication</button>
                </div>
            </form>
        `;
        
        document.getElementById('crudModalTitle').textContent = 'Edit Publication';
        document.getElementById('crudFormContainer').innerHTML = formHTML;
        document.getElementById('crudModal').classList.add('active');
        
    } catch (error) {
        console.error('Error loading paper for edit:', error);
        showNotification('Failed to load publication data', 'error');
    }
}


// ==================== ADD FORM FUNCTIONS ====================
// Update showAddInstitutionForm to remove department code
async function showAddInstitutionForm() {
    const formHTML = `
        <form id="institutionForm" onsubmit="saveInstitution(event)">
            <div class="form-group">
                <label class="form-label">Institution Name *</label>
                <input type="text" class="form-input" name="name" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Location *</label>
                    <input type="text" class="form-input" name="location" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Type *</label>
                    <select class="form-select" name="type" required>
                        <option value="">Select Type</option>
                        <option value="Public University">Public University</option>
                        <option value="Private University">Private University</option>
                        <option value="Research Center">Research Center</option>
                        <option value="Government">Government</option>
                        <option value="Corporate">Corporate</option>
                        <option value="Non-Profit">Non-Profit</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Established Date</label>
                    <input type="date" class="form-input" name="established_date">
                </div>
                <div class="form-group">
                    <label class="form-label">Website URL</label>
                    <input type="url" class="form-input" name="website_url" placeholder="https://example.com">
                </div>
            </div>
            
            <!-- Department Section - Simplified without code -->
            <div style="margin: 1rem 0; padding: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <h4 style="color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-building"></i> Add Departments
                </h4>
                
                <div id="departmentsContainer">
                    <div class="department-entry" style="margin-bottom: 1rem;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Department Name *</label>
                                <input type="text" class="form-input department-name" 
                                       name="departments[]" placeholder="e.g., Computer Science" required>
                            </div>
                            <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                                <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                                        style="width: 40px; height: 40px; padding: 0; display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="addDepartment()" 
                            style="padding: 8px 16px; font-size: 14px;">
                        <i class="fas fa-plus"></i> Add Another Department
                    </button>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Institution & Departments</button>
            </div>
        </form>
    `;
    
    document.getElementById('crudModalTitle').textContent = 'Add New Institution';
    document.getElementById('crudFormContainer').innerHTML = formHTML;
    document.getElementById('crudModal').classList.add('active');
    currentEditId = null;
    currentEditType = 'institution';
}

// Update addDepartment function
function addDepartment() {
    const container = document.getElementById('departmentsContainer');
    const departmentCount = container.querySelectorAll('.department-entry').length;
    
    const newEntry = document.createElement('div');
    newEntry.className = 'department-entry';
    newEntry.style.cssText = 'margin-bottom: 1rem;';
    newEntry.innerHTML = `
        <div class="form-row">
            <div class="form-group" style="flex: 2;">
                <label class="form-label">Department Name *</label>
                <input type="text" class="form-input department-name" 
                       name="departments[]" placeholder="e.g., Computer Science" required>
                <input type="hidden" class="department-id" name="department_ids[]" value="">
            </div>
            <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                        style="width: 40px; height: 40px; padding: 0;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(newEntry);
    
    // Show remove button on first entry if not already shown
    if (departmentCount === 1) {
        const firstRemoveBtn = container.querySelector('.department-entry:first-child .btn-danger');
        if (firstRemoveBtn) {
            firstRemoveBtn.style.display = 'block';
        }
    }
}

// Update showEditInstitutionForm
async function showEditInstitutionForm(id) {
    try {
        const response = await fetch(`/api/institutions/${id}`);
        const institution = await response.json();
        
        // Also fetch existing departments for this institution
        const deptResponse = await fetch(`/api/departments?institution_id=${id}`);
        const existingDepartments = await deptResponse.json();
        
        currentEditId = id;
        currentEditType = 'institution';
        
        let departmentsHTML = '';
        if (existingDepartments.length > 0) {
            existingDepartments.forEach((dept, index) => {
                departmentsHTML += `
                    <div class="department-entry" style="margin-bottom: 1rem;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">Department Name *</label>
                                <input type="text" class="form-input department-name" 
                                       name="departments[]" value="${dept.name || ''}" required>
                                <input type="hidden" class="department-id" 
                                       name="department_ids[]" value="${dept.department_id || ''}">
                            </div>
                            <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                                <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                                        style="width: 40px; height: 40px; padding: 0; ${existingDepartments.length === 1 ? 'display: none;' : ''}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            departmentsHTML = `
                <div class="department-entry" style="margin-bottom: 1rem;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 2;">
                            <label class="form-label">Department Name *</label>
                            <input type="text" class="form-input department-name" name="departments[]" required>
                            <input type="hidden" class="department-id" name="department_ids[]" value="">
                        </div>
                        <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                            <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                                    style="width: 40px; height: 40px; padding: 0; display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ... rest of the form stays similar but with department section ...
    } catch (error) {
        console.error('Error loading institution for edit:', error);
        showNotification('Failed to load institution data', 'error');
    }
}
// Update showEditInstitutionForm to include department IDs
async function showEditInstitutionForm(id) {
    try {
        const response = await fetch(`/api/institutions/${id}`);
        const institution = await response.json();
        
        // Also fetch existing departments for this institution
        const deptResponse = await fetch(`/api/departments?institution_id=${id}`);
        const existingDepartments = await deptResponse.json();
        
        currentEditId = id;
        currentEditType = 'institution';
        
        let departmentsHTML = '';
        if (existingDepartments.length > 0) {
            existingDepartments.forEach((dept, index) => {
                departmentsHTML += `
                    <div class="department-entry" style="margin-bottom: 1rem;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Department Name *</label>
                                <input type="text" class="form-input department-name" 
                                       name="departments[]" value="${dept.name || ''}" required>
                                <input type="hidden" class="department-id" 
                                       name="department_ids[]" value="${dept.department_id || ''}">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Department Code</label>
                                <input type="text" class="form-input department-code" 
                                       name="department_codes[]" value="${dept.department_code || ''}" 
                                       placeholder="e.g., CS">
                            </div>
                            <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                                <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                                        style="width: 40px; height: 40px; padding: 0; ${existingDepartments.length === 1 ? 'display: none;' : ''}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            departmentsHTML = `
                <div class="department-entry" style="margin-bottom: 1rem;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Department Name *</label>
                            <input type="text" class="form-input department-name" name="departments[]" required>
                            <input type="hidden" class="department-id" name="department_ids[]" value="">
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Department Code</label>
                            <input type="text" class="form-input department-code" name="department_codes[]" placeholder="e.g., CS">
                        </div>
                        <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                            <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                                    style="width: 40px; height: 40px; padding: 0; display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ... rest of the form HTML stays the same ...
        const formHTML = `
            <form id="institutionForm" onsubmit="saveInstitution(event)">
                <div class="form-group">
                    <label class="form-label">Institution Name *</label>
                    <input type="text" class="form-input" name="name" 
                           value="${institution.name || ''}" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Location *</label>
                        <input type="text" class="form-input" name="location" 
                               value="${institution.location || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select Type</option>
                            <option value="Public University" ${institution.type === 'Public University' ? 'selected' : ''}>Public University</option>
                            <option value="Private University" ${institution.type === 'Private University' ? 'selected' : ''}>Private University</option>
                            <option value="Research Center" ${institution.type === 'Research Center' ? 'selected' : ''}>Research Center</option>
                            <option value="Government" ${institution.type === 'Government' ? 'selected' : ''}>Government</option>
                            <option value="Corporate" ${institution.type === 'Corporate' ? 'selected' : ''}>Corporate</option>
                            <option value="Non-Profit" ${institution.type === 'Non-Profit' ? 'selected' : ''}>Non-Profit</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Established Date</label>
                        <input type="date" class="form-input" name="established_date" 
                               value="${institution.established_date ? institution.established_date.split('T')[0] : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website URL</label>
                        <input type="url" class="form-input" name="website_url" 
                               value="${institution.website_url || ''}" placeholder="https://example.com">
                    </div>
                </div>
                
                <!-- Department Section -->
                <div style="margin: 1rem 0; padding: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-building"></i> ${existingDepartments.length > 0 ? 'Edit' : 'Add'} Departments
                    </h4>
                    
                    <div id="departmentsContainer">
                        ${departmentsHTML}
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="addDepartment()" 
                                style="padding: 8px 16px; font-size: 14px;">
                            <i class="fas fa-plus"></i> Add Another Department
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Institution & Departments</button>
                </div>
            </form>
        `;
        
        document.getElementById('crudModalTitle').textContent = 'Edit Institution';
        document.getElementById('crudFormContainer').innerHTML = formHTML;
        document.getElementById('crudModal').classList.add('active');
        
    } catch (error) {
        console.error('Error loading institution for edit:', error);
        showNotification('Failed to load institution data', 'error');
    }
}

// Update the addDepartment function to include hidden ID field
function addDepartment() {
    const container = document.getElementById('departmentsContainer');
    const departmentCount = container.querySelectorAll('.department-entry').length;
    
    const newEntry = document.createElement('div');
    newEntry.className = 'department-entry';
    newEntry.style.cssText = 'margin-bottom: 1rem;';
    newEntry.innerHTML = `
        <div class="form-row">
            <div class="form-group" style="flex: 1;">
                <label class="form-label">Department Name *</label>
                <input type="text" class="form-input department-name" name="departments[]" placeholder="e.g., Computer Science" required>
                <input type="hidden" class="department-id" name="department_ids[]" value="">
            </div>
            <div class="form-group" style="flex: 1;">
                <label class="form-label">Department Code</label>
                <input type="text" class="form-input department-code" name="department_codes[]" placeholder="e.g., CS">
            </div>
            <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                        style="width: 40px; height: 40px; padding: 0;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
    `;
    
    container.appendChild(newEntry);
    
    // Show remove button on first entry if not already shown
    if (departmentCount === 1) {
        const firstRemoveBtn = container.querySelector('.department-entry:first-child .btn-danger');
        if (firstRemoveBtn) {
            firstRemoveBtn.style.display = 'block';
        }
    }
}

async function showAddResearcherForm() {
    const institutions = await getInstitutions();
    
    const formHTML = `
        <form id="researcherForm" onsubmit="saveResearcher(event)">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Full Name *</label>
                    <input type="text" class="form-input" name="full_name" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email *</label>
                    <input type="email" class="form-input" name="email" required>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Academic Rank</label>
                    <select class="form-select" name="academic_rank">
                        <option value="">Select Rank</option>
                        <option value="Professor">Professor</option>
                        <option value="Associate Professor">Associate Professor</option>
                        <option value="Assistant Professor">Assistant Professor</option>
                        <option value="Lecturer">Lecturer</option>
                        <option value="Postdoctoral Researcher">Postdoctoral Researcher</option>
                        <option value="PhD Student">PhD Student</option>
                        <option value="Research Assistant">Research Assistant</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Institution</label>
                    <select class="form-select" name="institution_id">
                        <option value="">Select Institution</option>
                        ${institutions.map(inst => 
                            `<option value="${inst.institution_id}">${inst.name}</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">ORCID ID</label>
                    <input type="text" class="form-input" name="orcid_id" placeholder="0000-0000-0000-0000">
                </div>
                <div class="form-group">
                    <label class="form-label">Google Scholar ID</label>
                    <input type="text" class="form-input" name="google_scholar_id">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Research Areas (comma-separated)</label>
                <input type="text" class="form-input" name="research_areas" placeholder="Machine Learning, AI, Data Science">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Researcher</button>
            </div>
        </form>
    `;
    
    document.getElementById('crudModalTitle').textContent = 'Add New Researcher';
    document.getElementById('crudFormContainer').innerHTML = formHTML;
    document.getElementById('crudModal').classList.add('active');
    currentEditId = null;
    currentEditType = 'researcher';
}

async function showAddProjectForm() {
    const [institutions, researchers] = await Promise.all([
        getInstitutions(),
        getResearchers()
    ]);
    
    const formHTML = `
        <form id="projectForm" onsubmit="saveProject(event)">
            <div class="form-group">
                <label class="form-label">Project Title *</label>
                <input type="text" class="form-input" name="project_title" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Institution</label>
                    <select class="form-select" name="institution_id" 
                            onchange="loadDepartmentsForProject(this.value)">
                        <option value="">Select Institution</option>
                        ${institutions.map(inst => 
                            `<option value="${inst.institution_id}">${inst.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Department *</label>
                    <select class="form-select" name="department_id" id="departmentSelect" required>
                        <option value="">Select Department *</option>
                    </select>
                    <small style="color: #f5576c; font-size: 12px;">Department is required</small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Start Date *</label>
                    <input type="date" class="form-input" name="start_date" required>
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-input" name="end_date">
                </div>
                <div class="form-group">
                    <label class="form-label">Status *</label>
                    <select class="form-select" name="project_status" required>
                        <option value="Planning">Planning</option>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="On Hold">On Hold</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Team Members</label>
                <select class="form-select" name="team_members" id="teamMembersSelect" multiple style="height: 150px;">
                    ${researchers.map(res => 
                        `<option value="${res.researcher_id}">${res.full_name} (${res.email})</option>`
                    ).join('')}
                </select>
                <small style="font-size: 12px; color: var(--text-secondary);">Hold Ctrl/Cmd to select multiple members</small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-textarea" name="description" rows="4" placeholder="Project description"></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--glass-border);">
                <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Project</button>
            </div>
        </form>
    `;
    
    document.getElementById('crudModalTitle').textContent = 'Add New Project';
    document.getElementById('crudFormContainer').innerHTML = formHTML;
    document.getElementById('crudModal').classList.add('active');
    currentEditId = null;
    currentEditType = 'project';
}
async function showAddPaperForm() {
    const [researchers, venues] = await Promise.all([
        getResearchers(),
        getPublicationVenues()
    ]);
    
    const formHTML = `
        <form id="paperForm" onsubmit="savePaper(event)">
            <div class="form-group">
                <label class="form-label">Title *</label>
                <input type="text" class="form-input" name="title" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Authors *</label>
                    <select class="form-select" name="authors" id="authorsSelect" multiple required style="height: 150px;">
                        ${researchers.map(res => 
                            `<option value="${res.researcher_id}">${res.full_name} (${res.email})</option>`
                        ).join('')}
                    </select>
                    <small class="form-error">Hold Ctrl/Cmd to select multiple authors</small>
                </div>
                <div class="form-group">
                    <label class="form-label">Publication Venue</label>
                    <select class="form-select" name="venue_id">
                        <option value="">Select Venue</option>
                        ${venues.map(venue => 
                            `<option value="${venue.venue_id}">${venue.name} (${venue.venue_type})</option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Publication Date</label>
                    <input type="date" class="form-input" name="publication_date">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="manuscript_status">
                        <option value="Submitted">Submitted</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Accepted">Accepted</option>
                        <option value="Published" selected>Published</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">DOI</label>
                    <input type="text" class="form-input" name="doi" placeholder="10.xxxx/xxxx">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Abstract</label>
                <textarea class="form-textarea" name="abstract" rows="6" placeholder="Paper abstract"></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label">Keywords (comma-separated)</label>
                <input type="text" class="form-input" name="keywords" placeholder="machine learning, ai, deep learning">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Publication</button>
            </div>
        </form>
    `;
    
    document.getElementById('crudModalTitle').textContent = 'Add New Publication';
    document.getElementById('crudFormContainer').innerHTML = formHTML;
    document.getElementById('crudModal').classList.add('active');
    currentEditId = null;
    currentEditType = 'paper';
}

async function showAddCitationForm() {
    // Get available papers
    const papers = await getAvailablePapers();
    
    const formHTML = `
        <form id="citationForm" onsubmit="saveCitation(event)">
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Citing Paper *</label>
                    <select class="form-select" name="citing_paper_id" required>
                        <option value="">Select citing paper</option>
                        ${papers.map(paper => 
                            `<option value="${paper.output_id}">
                                ID ${paper.output_id}: ${paper.title.substring(0, 50)}${paper.title.length > 50 ? '...' : ''}
                            </option>`
                        ).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Cited Paper *</label>
                    <select class="form-select" name="cited_paper_id" required>
                        <option value="">Select cited paper</option>
                        ${papers.map(paper => 
                            `<option value="${paper.output_id}">
                                ID ${paper.output_id}: ${paper.title.substring(0, 50)}${paper.title.length > 50 ? '...' : ''}
                            </option>`
                        ).join('')}
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Citation Date</label>
                <input type="date" class="form-input" name="citation_date" 
                       value="${new Date().toISOString().split('T')[0]}">
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Citation</button>
            </div>
        </form>
    `;
    
    document.getElementById('crudModalTitle').textContent = 'Add Citation';
    document.getElementById('crudFormContainer').innerHTML = formHTML;
    document.getElementById('crudModal').classList.add('active');
    currentEditId = null;
    currentEditType = 'citation';
}

// Helper function to get available papers
async function getAvailablePapers() {
    try {
        const response = await fetch('/api/papers');
        const papers = await response.json();
        return papers;
    } catch (error) {
        console.error('Error fetching papers:', error);
        return [];
    }
}
function showAddFundingForm() {
    const formHTML = `
        <form id="fundingForm" onsubmit="saveFunding(event)">
            <div class="form-group">
                <label class="form-label">Grant Title *</label>
                <input type="text" class="form-input" name="grant_title" required>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Funding Agency *</label>
                    <input type="text" class="form-input" name="funding_agency" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Grant Number</label>
                    <input type="text" class="form-input" name="grant_number">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Start Date *</label>
                    <input type="date" class="form-input" name="start_date" required 
                           value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-input" name="end_date">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Grant Amount (PKR) *</label>
                    <input type="number" class="form-input" name="total_amount" required min="0" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="grant_status">
                        <option value="Active" selected>Active</option>
                        <option value="Completed">Completed</option>
                        <option value="Terminated">Terminated</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
            </div>
            
            <!-- Removed description field since it doesn't exist in your database -->
            
            <div class="form-group">
                <label class="form-label">Project IDs (comma-separated)</label>
                <input type="text" class="form-input" name="project_ids" placeholder="1, 2, 3">
                <small style="font-size: 12px; color: var(--text-secondary);">
                    Enter comma-separated project IDs to allocate funding
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Allocation per Project (PKR)</label>
                <input type="number" class="form-input" name="allocation_amount" min="0" step="0.01">
                <small style="font-size: 12px; color: var(--text-secondary);">
                    Leave blank to divide total amount equally among projects
                </small>
            </div>
            
            <div style="margin: 1rem 0; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                    <i class="fas fa-info-circle" style="color: #667eea; margin-right: 8px;"></i>
                    Note: Description field not available in your database schema.
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Funding</button>
            </div>
        </form>
    `;
    
    document.getElementById('crudModalTitle').textContent = 'Add Funding/Grant';
    document.getElementById('crudFormContainer').innerHTML = formHTML;
    document.getElementById('crudModal').classList.add('active');
    currentEditId = null;
    currentEditType = 'funding';
}
async function showEditInstitutionForm(id) {
    try {
        const response = await fetch(`/api/institutions/${id}`);
        const institution = await response.json();
        
        // Also fetch existing departments for this institution
        const deptResponse = await fetch(`/api/departments?institution_id=${id}`);
        const existingDepartments = await deptResponse.json();
        
        currentEditId = id;
        currentEditType = 'institution';
        
        let departmentsHTML = '';
        if (existingDepartments.length > 0) {
            existingDepartments.forEach((dept, index) => {
                departmentsHTML += `
                    <div class="department-entry" style="margin-bottom: 1rem;">
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Department Name *</label>
                                <input type="text" class="form-input department-name" 
                                       name="departments[]" value="${dept.name || ''}" required>
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">Department Code</label>
                                <input type="text" class="form-input department-code" 
                                       name="department_codes[]" value="${dept.department_code || ''}" 
                                       placeholder="e.g., CS">
                            </div>
                            <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                                <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                                        style="width: 40px; height: 40px; padding: 0; ${existingDepartments.length === 1 ? 'display: none;' : ''}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            departmentsHTML = `
                <div class="department-entry" style="margin-bottom: 1rem;">
                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Department Name *</label>
                            <input type="text" class="form-input department-name" name="departments[]" required>
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label class="form-label">Department Code</label>
                            <input type="text" class="form-input department-code" name="department_codes[]" placeholder="e.g., CS">
                        </div>
                        <div class="form-group" style="width: 60px; margin-top: 1.5rem;">
                            <button type="button" class="btn btn-danger" onclick="removeDepartment(this)" 
                                    style="width: 40px; height: 40px; padding: 0; display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        const formHTML = `
            <form id="institutionForm" onsubmit="saveInstitution(event)">
                <div class="form-group">
                    <label class="form-label">Institution Name *</label>
                    <input type="text" class="form-input" name="name" 
                           value="${institution.name || ''}" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Location *</label>
                        <input type="text" class="form-input" name="location" 
                               value="${institution.location || ''}" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type *</label>
                        <select class="form-select" name="type" required>
                            <option value="">Select Type</option>
                            <option value="Public University" ${institution.type === 'Public University' ? 'selected' : ''}>Public University</option>
                            <option value="Private University" ${institution.type === 'Private University' ? 'selected' : ''}>Private University</option>
                            <option value="Research Center" ${institution.type === 'Research Center' ? 'selected' : ''}>Research Center</option>
                            <option value="Government" ${institution.type === 'Government' ? 'selected' : ''}>Government</option>
                            <option value="Corporate" ${institution.type === 'Corporate' ? 'selected' : ''}>Corporate</option>
                            <option value="Non-Profit" ${institution.type === 'Non-Profit' ? 'selected' : ''}>Non-Profit</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Established Date</label>
                        <input type="date" class="form-input" name="established_date" 
                               value="${institution.established_date ? institution.established_date.split('T')[0] : ''}">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Website URL</label>
                        <input type="url" class="form-input" name="website_url" 
                               value="${institution.website_url || ''}" placeholder="https://example.com">
                    </div>
                </div>
                
                <!-- Department Section -->
                <div style="margin: 1rem 0; padding: 1.5rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                    <h4 style="color: var(--text-primary); margin-bottom: 1rem; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-building"></i> ${existingDepartments.length > 0 ? 'Edit' : 'Add'} Departments
                    </h4>
                    
                    <div id="departmentsContainer">
                        ${departmentsHTML}
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="addDepartment()" 
                                style="padding: 8px 16px; font-size: 14px;">
                            <i class="fas fa-plus"></i> Add Another Department
                        </button>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Institution & Departments</button>
                </div>
            </form>
        `;
        
        document.getElementById('crudModalTitle').textContent = 'Edit Institution';
        document.getElementById('crudFormContainer').innerHTML = formHTML;
        document.getElementById('crudModal').classList.add('active');
        
    } catch (error) {
        console.error('Error loading institution for edit:', error);
        showNotification('Failed to load institution data', 'error');
    }
}
// ==================== SAVE FUNCTIONS ====================

async function saveInstitution(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Get department data
    const departmentNames = formData.getAll('departments[]');
    const departmentIds = formData.getAll('department_ids[]');
    
    const departments = departmentNames.map((name, index) => ({
        department_id: departmentIds[index] || null,
        name: name.trim()
    })).filter(dept => dept.name !== ''); // Filter out empty departments
    
    // Create institution data
    const institutionData = {
        name: data.name,
        location: data.location,
        type: data.type,
        established_date: data.established_date || null,
        website_url: data.website_url || null,
        departments: departments
    };
    
    try {
        const url = currentEditId ? `/api/institutions/${currentEditId}` : '/api/institutions';
        const method = currentEditId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(institutionData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || 'Institution saved successfully', 'success');
            closeCrudModal();
            loadInstitutions();
        } else {
            showNotification(result.error || 'Failed to save institution', 'error');
        }
    } catch (error) {
        console.error('Error saving institution:', error);
        showNotification('Failed to save institution', 'error');
    }
}
async function saveResearcher(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Handle field mapping for google_scholar_id -> profile_url
    if (data.google_scholar_id) {
        data.profile_url = data.google_scholar_id;
        delete data.google_scholar_id;
    }
    
    // Handle multi-select fields
    if (data.team_members) {
        data.team_members = Array.isArray(data.team_members) ? data.team_members : [data.team_members];
    }
    
    try {
        const url = currentEditId ? `/api/researchers/${currentEditId}` : '/api/researchers';
        const method = currentEditId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || 'Researcher saved successfully', 'success');
            closeCrudModal();
            loadResearchers();
        } else {
            showNotification(result.error || 'Failed to save researcher', 'error');
        }
    } catch (error) {
        console.error('Error saving researcher:', error);
        showNotification('Failed to save researcher', 'error');
    }
}

let currentUser = null;

// Check if user is logged in on page load
// Update the initial DOMContentLoaded listener:
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed');
    
    // Start initialization with a small delay
    setTimeout(() => {
        initializeApp();
    }, 200);
});

// Add this at the end of your JavaScript, before the window function exports
window.addEventListener('load', function() {
    console.log('Page fully loaded, setting up cursor effects');
    
    // Re-setup cursor effects to ensure they work
    setTimeout(() => {
        if (typeof setupCustomCursor === 'function') {
            setupCustomCursor();
        }
        if (typeof setupClickEffects === 'function') {
            setupClickEffects();
        }
    }, 500);
});
function updateUIForAuth() {
    const loginBtn = document.getElementById('loginBtn');
    const userInfo = document.getElementById('userInfo');
    
    if (currentUser) {
        // Update UI for logged in user
        loginBtn.style.display = 'none';
        userInfo.style.display = 'block';
        userInfo.innerHTML = `
            <span>Welcome, ${currentUser.full_name || currentUser.username}!</span>
            <button class="btn btn-secondary" onclick="logout()">Logout</button>
        `;
    } else {
        // Update UI for guest
        loginBtn.style.display = 'block';
        userInfo.style.display = 'none';
    }
}

function login(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    fetch('/api/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            localStorage.setItem('token', result.token);
            currentUser = result.user;
            updateUIForAuth();
            closeLoginModal();
            showNotification('Login successful', 'success');
        } else {
            showNotification(result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Login error:', error);
        showNotification('Login failed', 'error');
    });
}

function register(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    if (data.password !== data.confirm_password) {
        showNotification('Passwords do not match', 'error');
        return;
    }
    
    fetch('/api/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            localStorage.setItem('token', result.token);
            currentUser = result.user;
            updateUIForAuth();
            closeRegisterModal();
            showNotification('Registration successful', 'success');
        } else {
            showNotification(result.error, 'error');
        }
    })
    .catch(error => {
        console.error('Registration error:', error);
        showNotification('Registration failed', 'error');
    });
}

function logout() {
    localStorage.removeItem('token');
    currentUser = null;
    updateUIForAuth();
    showNotification('Logged out', 'success');
}

function showLoginModal() {
    document.getElementById('loginModal').classList.add('active');
}

function closeLoginModal() {
    document.getElementById('loginModal').classList.remove('active');
}

function showRegisterModal() {
    closeLoginModal();
    document.getElementById('registerModal').classList.add('active');
}
// Separate handler function
function handleClickEffect(e) {
    // Prevent double bubbling
    e.stopPropagation();
    
    // Get element center position
    const rect = this.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    // Create particles at element center
    createParticleBurst(centerX, centerY, 10);
    createRippleEffect(centerX, centerY);
    
    // Add a subtle scale animation to the clicked element
    this.style.transform = 'scale(0.95)';
    setTimeout(() => {
        this.style.transform = '';
    }, 150);
    
    console.log('Click effect triggered at', centerX, centerY);
}
function closeRegisterModal() {
    document.getElementById('registerModal').classList.remove('active');
}
async function saveProject(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Handle multi-select fields
    if (data.team_members) {
        data.team_members = Array.isArray(data.team_members) ? data.team_members : [data.team_members];
    }
    
    try {
        const url = currentEditId ? `/api/projects/${currentEditId}` : '/api/projects';
        const method = currentEditId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || 'Project saved successfully', 'success');
            closeCrudModal();
            loadProjects();
        } else {
            showNotification(result.error || 'Failed to save project', 'error');
        }
    } catch (error) {
        console.error('Error saving project:', error);
        showNotification('Failed to save project', 'error');
    }
}
async function savePaper(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Handle multi-select fields
    if (data.authors) {
        // Convert to array if it's a string (single selection)
        if (typeof data.authors === 'string') {
            data.authors = [data.authors];
        }
    }
    
    // Handle keywords - ensure it's a string
    if (data.keywords && typeof data.keywords !== 'string') {
        data.keywords = String(data.keywords);
    }
    
    try {
        const url = currentEditId ? `/api/papers/${currentEditId}` : '/api/papers';
        const method = currentEditId ? 'PUT' : 'POST';
        
        console.log('Saving paper data:', data); // Debug log
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || 'Publication saved successfully', 'success');
            closeCrudModal();
            loadPapers();
        } else {
            showNotification(result.error || 'Failed to save publication', 'error');
        }
    } catch (error) {
        console.error('Error saving paper:', error);
        showNotification('Failed to save publication', 'error');
    }
}
async function saveCitation(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Check if citing and cited are the same paper
    if (data.citing_paper_id === data.cited_paper_id) {
        showNotification('A paper cannot cite itself', 'error');
        return;
    }
    
    const citationData = {
        citing_paper_id: data.citing_paper_id,
        cited_paper_id: data.cited_paper_id,
        citation_date: data.citation_date || new Date().toISOString().split('T')[0]
    };
    
    try {
        const response = await fetch('/api/citations', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(citationData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || 'Citation added successfully', 'success');
            closeCrudModal();
        } else {
            showNotification(result.error || 'Failed to add citation: ' + (result.message || ''), 'error');
        }
    } catch (error) {
        console.error('Error adding citation:', error);
        showNotification('Failed to add citation', 'error');
    }
}async function saveFunding(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);
    
    // Parse project IDs
    let projectIds = [];
    if (data.project_ids && data.project_ids.trim()) {
        projectIds = data.project_ids.split(',').map(id => parseInt(id.trim())).filter(id => !isNaN(id));
    }
    
    // Only include fields that exist in your database
    const grantData = {
        grant_title: data.grant_title,
        funding_agency: data.funding_agency,
        grant_number: data.grant_number || null,
        start_date: data.start_date,
        end_date: data.end_date || null,
        total_amount: data.total_amount || 0,
        grant_status: data.grant_status || 'Active',
        project_ids: projectIds,
        allocation_amount: data.allocation_amount || null
    };
    
    try {
        const response = await fetch('/api/grants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(grantData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || 'Funding added successfully', 'success');
            closeCrudModal();
        } else {
            showNotification(result.error || 'Failed to add funding', 'error');
        }
    } catch (error) {
        console.error('Error adding funding:', error);
        showNotification('Failed to add funding', 'error');
    }
}
// ==================== DELETE FUNCTION ====================

function confirmDelete(type, id, name) {
    // Escape any single quotes in the name
    const escapedName = name.replace(/'/g, "\\'");
    
    currentEditId = id;
    currentEditType = type;
    
    let message = `Are you sure you want to delete "${name}"?`;
    
    // Add warnings based on entity type
    if (type === 'institution') {
        message += "\n\n Warning: This will also delete all departments associated with this institution!";
    }
    if (type === 'paper') {
        message += "\n\n Warning: All citations to/from this paper will also be removed!";
    }
    if (type === 'project') {
        message += "\n\n Warning: Project outputs will be unlinked from this project!";
    }
    if (type === 'paper') {
        message += "\n\n Warning: This will delete the paper and all associated citations!";
    }
    if (type === 'institution') {
        message += "\n\n Warning: This will delete the institution and ALL its departments!";
    }
    document.getElementById('confirmModalTitle').textContent = `Delete ${type.charAt(0).toUpperCase() + type.slice(1)}`;
    document.getElementById('confirmModalMessage').textContent = message;
    document.getElementById('confirmModal').classList.add('active');
    
    // Set up the confirm button
    const confirmBtn = document.getElementById('confirmActionBtn');
    confirmBtn.onclick = function() {
        performDelete(type, id);
    };
}
function closeCrudModal() {
    document.getElementById('crudModal').classList.remove('active');
    currentEditId = null;
    currentEditType = null;
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.remove('active');
    currentEditId = null;
    currentEditType = null;
}
async function performDelete(type, id) {
    try {
        const response = await fetch(`/api/${type}s/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || `${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully`, 'success');
            closeConfirmModal();
            loadInstitutions(); // Refresh the list
        } else {
            showNotification(result.error || `Failed to delete ${type}`, 'error');
        }
    } catch (error) {
        console.error(`Error deleting ${type}:`, error);
        showNotification(`Failed to delete ${type}`, 'error');
    }
}
async function performDelete(type, id) {
    try {
        const response = await fetch(`/api/${type}s/${id}`, {
            method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || `${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully`, 'success');
            closeConfirmModal();
            
            // Refresh the current section
            switch(type) {
                case 'institution':
                    loadInstitutions();
                    break;
                case 'researcher':
                    loadResearchers();
                    break;
                case 'project':
                    loadProjects();
                    break;
                case 'paper':
                    loadPapers();
                    break;
            }
        } else {
            showNotification(result.error || `Failed to delete ${type}`, 'error');
        }
    } catch (error) {
        console.error(`Error deleting ${type}:`, error);
        showNotification(`Failed to delete ${type}`, 'error');
    }
}

// ==================== HELPER FUNCTIONS ====================

function closeCrudModal() {
    document.getElementById('crudModal').classList.remove('active');
    currentEditId = null;
    currentEditType = null;
}

function closeConfirmModal() {
    document.getElementById('confirmModal').classList.remove('active');
    currentEditId = null;
    currentEditType = null;
}
// Helper function to get available projects for dropdown
async function getAvailableProjects() {
    try {
        const response = await fetch('/api/projects');
        const projects = await response.json();
        return projects;
    } catch (error) {
        console.error('Error fetching projects:', error);
        return [];
    }
}

// Update the showAddFundingForm() function:
async function showAddFundingForm() {
    // Get available projects first
    const projects = await getAvailableProjects();
    
    // Generate a unique grant number suggestion
    const suggestedGrantNumber = 'GRANT-' + Date.now().toString().slice(-6);
    
    const formHTML = `
        <form id="fundingForm" onsubmit="saveFunding(event)">
            <div class="form-group">
                <label class="form-label">Grant Title *</label>
                <input type="text" class="form-input" name="grant_title" required 
                       placeholder="e.g., AI Research Initiative 2024">
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Funding Agency *</label>
                    <input type="text" class="form-input" name="funding_agency" required 
                           placeholder="e.g., National Science Foundation">
                </div>
                <div class="form-group">
                    <label class="form-label">Grant Number</label>
                    <input type="text" class="form-input" name="grant_number" 
                           placeholder="${suggestedGrantNumber}" 
                           title="Leave blank to auto-generate, or enter a unique grant number">
                    <small style="font-size: 12px; color: var(--text-secondary);">
                        Optional - leave blank for auto-generated number
                    </small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Start Date *</label>
                    <input type="date" class="form-input" name="start_date" required 
                           value="${new Date().toISOString().split('T')[0]}">
                </div>
                <div class="form-group">
                    <label class="form-label">End Date</label>
                    <input type="date" class="form-input" name="end_date"
                           title="Optional - leave blank for ongoing grants">
                    <small style="font-size: 12px; color: var(--text-secondary);">
                        Optional - leave blank for ongoing grants
                    </small>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Grant Amount (PKR) *</label>
                    <input type="number" class="form-input" name="total_amount" required 
                           min="0" step="0.01" placeholder="1000000">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" name="grant_status">
                        <option value="Active" selected>Active</option>
                        <option value="Completed">Completed</option>
                        <option value="Terminated">Terminated</option>
                        <option value="Pending">Pending</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">Select Projects to Fund</label>
                <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--glass-border); border-radius: 8px; padding: 10px;">
                    ${projects.length > 0 ? 
                        projects.map(project => `
                            <div style="margin-bottom: 8px; padding: 5px; background: rgba(255,255,255,0.05); border-radius: 5px;">
                                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                                    <input type="checkbox" name="project_ids[]" value="${project.project_id}" style="margin: 0;">
                                    <span style="font-size: 0.9rem;">
                                        <strong>ID ${project.project_id}:</strong> ${project.project_title}
                                        ${project.institution_name ? ` (${project.institution_name})` : ''}
                                    </span>
                                </label>
                            </div>
                        `).join('') : 
                        '<div style="padding: 20px; text-align: center; color: var(--text-secondary);">No projects available</div>'
                    }
                </div>
                <small style="font-size: 12px; color: var(--text-secondary);">
                    Select projects to allocate funding to (optional)
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label">Allocation per Project (PKR)</label>
                <input type="number" class="form-input" name="allocation_amount" min="0" step="0.01"
                       title="Optional - will divide total amount equally if left blank">
                <small style="font-size: 12px; color: var(--text-secondary);">
                    Optional - leave blank to divide total amount equally among selected projects
                </small>
            </div>
            
            <div style="margin: 1rem 0; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 4px solid #667eea;">
                <div style="font-size: 0.85rem; color: var(--text-primary); display: flex; align-items: flex-start; gap: 10px;">
                    <i class="fas fa-info-circle" style="color: #667eea; margin-top: 2px;"></i>
                    <div>
                        <strong>Note:</strong> Grant numbers must be unique. If you leave the grant number blank, 
                        a unique number will be auto-generated. If you enter a grant number, make sure it hasn't been used before.
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="closeCrudModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Add Funding</button>
            </div>
        </form>
    `;
    
    document.getElementById('crudModalTitle').textContent = 'Add Funding/Grant';
    document.getElementById('crudFormContainer').innerHTML = formHTML;
    document.getElementById('crudModal').classList.add('active');
    currentEditId = null;
    currentEditType = 'funding';
}
// Also update the saveFunding function to handle checkbox array:
async function saveFunding(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);
    
    // Get all checked project IDs
    const projectCheckboxes = form.querySelectorAll('input[name="project_ids[]"]:checked');
    const projectIds = Array.from(projectCheckboxes).map(cb => parseInt(cb.value));
    
    // Get grant number or generate one
    let grantNumber = formData.get('grant_number');
    if (!grantNumber || grantNumber.trim() === '') {
        // Auto-generate a unique grant number
        grantNumber = 'GRANT-' + Date.now().toString().slice(-6) + '-' + Math.random().toString(36).substr(2, 3).toUpperCase();
    }
    
    // Get other form data
    const data = {
        grant_title: formData.get('grant_title'),
        funding_agency: formData.get('funding_agency'),
        grant_number: grantNumber,
        start_date: formData.get('start_date'),
        end_date: formData.get('end_date') || null,
        total_amount: parseFloat(formData.get('total_amount')) || 0,
        grant_status: formData.get('grant_status') || 'Active',
        project_ids: projectIds,
        allocation_amount: formData.get('allocation_amount') ? parseFloat(formData.get('allocation_amount')) : null
    };
    
    try {
        const response = await fetch('/api/grants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showNotification(result.message || 'Funding added successfully', 'success');
            closeCrudModal();
        } else {
            showNotification(result.error || 'Failed to add funding: ' + (result.message || ''), 'error');
        }
    } catch (error) {
        console.error('Error adding funding:', error);
        showNotification('Failed to add funding', 'error');
    }
}async function getInstitutions() {
    try {
        const response = await fetch('/api/institutions');
        return await response.json();
    } catch (error) {
        console.error('Error fetching institutions:', error);
        return [];
    }
}

async function getResearchers() {
    try {
        const response = await fetch('/api/researchers');
        return await response.json();
    } catch (error) {
        console.error('Error fetching researchers:', error);
        return [];
    }
}
// 1. Collaboration Network Visualization
// Show researcher collaboration patterns
async function getCollaborationNetwork() {
    // Query COLLABORATION table to find co-authors
    const [collaborations] = await promisePool.execute(`
        SELECT c1.researcher_id as researcher1, c2.researcher_id as researcher2, 
               COUNT(DISTINCT c1.paper_id) as collaboration_count
        FROM COLLABORATION c1
        JOIN COLLABORATION c2 ON c1.paper_id = c2.paper_id 
            AND c1.researcher_id < c2.researcher_id
        GROUP BY c1.researcher_id, c2.researcher_id
        ORDER BY collaboration_count DESC
    `);
    return collaborations;
}

// 2. Research Trend Analysis
async function getResearchTrends() {
    const [trends] = await promisePool.execute(`
        SELECT YEAR(p.publication_date) as year, 
               GROUP_CONCAT(DISTINCT k.keyword_text) as trending_keywords,
               COUNT(DISTINCT p.paper_id) as paper_count
        FROM PAPER p
        JOIN PAPER_KEYWORD pk ON p.paper_id = pk.paper_id
        JOIN KEYWORD k ON pk.keyword_id = k.keyword_id
        WHERE p.publication_date >= DATE_SUB(NOW(), INTERVAL 5 YEAR)
        GROUP BY YEAR(p.publication_date)
        ORDER BY year DESC
    `);
    return trends;
}

// 3. Funding Analysis Dashboard
async function getFundingAnalytics() {
    const [analytics] = await promisePool.execute(`
        SELECT 
            g.funding_agency,
            COUNT(DISTINCT g.grant_id) as grant_count,
            SUM(g.grant_amount) as total_funding,
            COUNT(DISTINCT pg.project_id) as funded_projects,
            AVG(g.grant_amount) as average_grant_size
        FROM \`GRANT\` g
        LEFT JOIN PROJECT_GRANT pg ON g.grant_id = pg.grant_id
        GROUP BY g.funding_agency
        ORDER BY total_funding DESC
    `);
    return analytics;
}
// 1. Email alerts for new citations
async function sendCitationAlerts() {
    // Find researchers whose papers were recently cited
    const [newCitations] = await promisePool.execute(`
        SELECT c.citation_id, r.researcher_id, r.email, r.full_name,
               ro.title as cited_paper, ci.title as citing_paper,
               cit.citation_date
        FROM CITATION cit
        JOIN RESEARCH_OUTPUT ro ON cit.cited_output_id = ro.output_id
        JOIN PAPER p ON ro.output_id = p.paper_id
        JOIN COLLABORATION col ON p.paper_id = col.paper_id
        JOIN RESEARCHER r ON col.researcher_id = r.researcher_id
        JOIN RESEARCH_OUTPUT ci ON cit.citing_output_id = ci.output_id
        WHERE cit.citation_date >= DATE_SUB(NOW(), INTERVAL 1 DAY)
        AND r.email IS NOT NULL
        GROUP BY r.researcher_id, cit.citation_id
    `);
    
    // Send email to each researcher (pseudo-code)
    newCitations.forEach(citation => {
        // sendEmail(citation.email, 'New Citation Alert', ...);
    });
}

// 2. Project deadline reminders
async function sendProjectReminders() {
    const [upcomingDeadlines] = await promisePool.execute(`
        SELECT rp.project_id, rp.project_title, rp.end_date,
               GROUP_CONCAT(DISTINCT r.email) as team_emails,
               GROUP_CONCAT(DISTINCT r.full_name) as team_members
        FROM RESEARCH_PROJECT rp
        JOIN PROJECT_MEMBER pm ON rp.project_id = pm.project_id
        JOIN RESEARCHER r ON pm.researcher_id = r.researcher_id
        WHERE rp.end_date BETWEEN NOW() AND DATE_ADD(NOW(), INTERVAL 30 DAY)
        AND rp.project_status = 'Active'
        AND r.email IS NOT NULL
        GROUP BY rp.project_id
    `);
    
    // Send reminder emails
}
// Helper function to get publication venues
async function getPublicationVenues() {
    try {
        const response = await fetch('/api/venues');
        return await response.json();
    } catch (error) {
        console.error('Error fetching venues:', error);
        return [];
    }
}
// Trigger initial load
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure DOM is fully ready
    setTimeout(initializeApp, 100);
});

// Also refresh when page becomes visible again
document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
        // Page is visible again, refresh current section
        setTimeout(refreshCurrentSection, 500);
    }
});

// Refresh on window focus
window.addEventListener('focus', function() {
    setTimeout(refreshCurrentSection, 1000);
});
        // Make functions globally available
        window.showSection = showSection;
        window.showDetailsModal = showDetailsModal;
        window.closeModal = closeModal;
        window.setGridView = setGridView;
        window.setListView = setListView;
        window.resetLayout = resetLayout;
        window.refreshInstitutions = refreshInstitutions;
        window.refreshResearchers = refreshResearchers;
        window.refreshProjects = refreshProjects;
        window.refreshPapers = refreshPapers;
        window.refreshAnalytics = refreshAnalytics;
        window.filterInstitutions = filterInstitutions;
        window.viewResearcher = viewResearcher;
        window.viewProject = viewProject;
        window.viewPaper = viewPaper;
        window.setCompactView = setCompactView;
// Make new functions globally available
window.showAddInstitutionForm = showAddInstitutionForm;
window.showEditInstitutionForm = showEditInstitutionForm;
window.showAddResearcherForm = showAddResearcherForm;
window.showEditResearcherForm = showEditResearcherForm;
window.showAddProjectForm = showAddProjectForm;
window.showEditProjectForm = showEditProjectForm;
window.showAddPaperForm = showAddPaperForm;
window.showEditPaperForm = showEditPaperForm;
window.showAddCitationForm = showAddCitationForm;
window.showAddFundingForm = showAddFundingForm;
window.confirmDelete = confirmDelete;
window.closeCrudModal = closeCrudModal;
window.closeConfirmModal = closeConfirmModal;
window.loadDepartments = loadDepartments;
// Add these to your existing global functions:
window.performDelete = performDelete;
window.showEditInstitutionForm = showEditInstitutionForm;
// Make sure these functions are in the global scope
window.getInstitutions = getInstitutions;
window.getResearchers = getResearchers;
window.getPublicationVenues = getPublicationVenues;
window.setupCustomCursor = setupCustomCursor;
window.setupClickEffects = setupClickEffects;
window.createParticleBurst = createParticleBurst;
window.createRippleEffect = createRippleEffect;
window.refreshCursorEffects = refreshCursorEffects;
    </script>
</body>
</html>